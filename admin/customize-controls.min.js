(function(exports,$){var Container,focus,normalizedTransitionendEventName,api=wp.customize;api.OverlayNotification=api.Notification.extend({loading:false,initialize:function(code,params){var notification=this;api.Notification.prototype.initialize.call(notification,code,params);notification.containerClasses+=' notification-overlay';if(notification.loading){notification.containerClasses+=' notification-loading'}},render:function(){var li=api.Notification.prototype.render.call(this);li.on('keydown',_.bind(this.handleEscape,this));return li},handleEscape:function(event){var notification=this;if(27===event.which){event.stopPropagation();if(notification.dismissible&&notification.parent){notification.parent.remove(notification.code)}}}});api.Notifications=api.Values.extend({alt:false,defaultConstructor:api.Notification,initialize:function(options){var collection=this;api.Values.prototype.initialize.call(collection,options);_.bindAll(collection,'constrainFocus');collection._addedIncrement=0;collection._addedOrder={};collection.bind('add',function(notification){collection.trigger('change',notification)});collection.bind('removed',function(notification){collection.trigger('change',notification)})},count:function(){return _.size(this._value)},add:function(notification,notificationObject){var collection=this,code,instance;if('string'===typeof notification){code=notification;instance=notificationObject}else{code=notification.code;instance=notification}if(!collection.has(code)){collection._addedIncrement+=1;collection._addedOrder[code]=collection._addedIncrement}return api.Values.prototype.add.call(collection,code,instance)},remove:function(code){var collection=this;delete collection._addedOrder[code];return api.Values.prototype.remove.call(this,code)},get:function(args){var collection=this,notifications,errorTypePriorities,params;notifications=_.values(collection._value);params=_.extend({sort:false},args);if(params.sort){errorTypePriorities={error:4,warning:3,success:2,info:1};notifications.sort(function(a,b){var aPriority=0,bPriority=0;if(!_.isUndefined(errorTypePriorities[a.type])){aPriority=errorTypePriorities[a.type]}if(!_.isUndefined(errorTypePriorities[b.type])){bPriority=errorTypePriorities[b.type]}if(aPriority!==bPriority){return bPriority-aPriority}return collection._addedOrder[b.code]-collection._addedOrder[a.code]})}return notifications},render:function(){var collection=this,notifications,hadOverlayNotification=false,hasOverlayNotification,overlayNotifications=[],previousNotificationsByCode={},listElement,focusableElements;if(!collection.container||!collection.container.length){return}notifications=collection.get({sort:true});collection.container.toggle(0!==notifications.length);if(collection.container.is(collection.previousContainer)&&_.isEqual(notifications,collection.previousNotifications)){return}listElement=collection.container.children('ul').first();if(!listElement.length){listElement=$('<ul></ul>');collection.container.append(listElement)}listElement.find('> [data-code]').remove();_.each(collection.previousNotifications,function(notification){previousNotificationsByCode[notification.code]=notification});_.each(notifications,function(notification){var notificationContainer;if(wp.a11y&&(!previousNotificationsByCode[notification.code]||!_.isEqual(notification.message,previousNotificationsByCode[notification.code].message))){wp.a11y.speak(notification.message,'assertive')}notificationContainer=$(notification.render());notification.container=notificationContainer;listElement.append(notificationContainer);if(notification.extended(api.OverlayNotification)){overlayNotifications.push(notification)}});hasOverlayNotification=Boolean(overlayNotifications.length);if(collection.previousNotifications){hadOverlayNotification=Boolean(_.find(collection.previousNotifications,function(notification){return notification.extended(api.OverlayNotification)}))}if(hasOverlayNotification!==hadOverlayNotification){$(document.body).toggleClass('customize-loading',hasOverlayNotification);collection.container.toggleClass('has-overlay-notifications',hasOverlayNotification);if(hasOverlayNotification){collection.previousActiveElement=document.activeElement;$(document).on('keydown',collection.constrainFocus)}else{$(document).off('keydown',collection.constrainFocus)}}if(hasOverlayNotification){collection.focusContainer=overlayNotifications[overlayNotifications.length-1].container;collection.focusContainer.prop('tabIndex',-1);focusableElements=collection.focusContainer.find(':focusable');if(focusableElements.length){focusableElements.first().focus()}else{collection.focusContainer.focus()}}else if(collection.previousActiveElement){$(collection.previousActiveElement).focus();collection.previousActiveElement=null}collection.previousNotifications=notifications;collection.previousContainer=collection.container;collection.trigger('rendered')},constrainFocus:function constrainFocus(event){var collection=this,focusableElements;event.stopPropagation();if(9!==event.which){return}focusableElements=collection.focusContainer.find(':focusable');if(0===focusableElements.length){focusableElements=collection.focusContainer}if(!$.contains(collection.focusContainer[0],event.target)||!$.contains(collection.focusContainer[0],document.activeElement)){event.preventDefault();focusableElements.first().focus()}else if(focusableElements.last().is(event.target)&&!event.shiftKey){event.preventDefault();focusableElements.first().focus()}else if(focusableElements.first().is(event.target)&&event.shiftKey){event.preventDefault();focusableElements.last().focus()}}});api.Setting=api.Value.extend({defaults:{transport:'refresh',dirty:false},initialize:function(id,value,options){var setting=this,params;params=_.extend({previewer:api.previewer},setting.defaults,options||{});api.Value.prototype.initialize.call(setting,value,params);setting.id=id;setting._dirty=params.dirty;setting.notifications=new api.Notifications();setting.bind(setting.preview)},preview:function(){var setting=this,transport;transport=setting.transport;if('postMessage'===transport&&!api.state('previewerAlive').get()){transport='refresh'}if('postMessage'===transport){setting.previewer.send('setting',[setting.id,setting()])}else if('refresh'===transport){setting.previewer.refresh()}},findControls:function(){var setting=this,controls=[];api.control.each(function(control){_.each(control.settings,function(controlSetting){if(controlSetting.id===setting.id){controls.push(control)}})});return controls}});api._latestRevision=0;api._lastSavedRevision=0;api._latestSettingRevisions={};api.bind('change',function incrementChangedSettingRevision(setting){api._latestRevision+=1;api._latestSettingRevisions[setting.id]=api._latestRevision});api.bind('ready',function(){api.bind('add',function incrementCreatedSettingRevision(setting){if(setting._dirty){api._latestRevision+=1;api._latestSettingRevisions[setting.id]=api._latestRevision}})});api.dirtyValues=function dirtyValues(options){var values={};api.each(function(setting){var settingRevision;if(!setting._dirty){return}settingRevision=api._latestSettingRevisions[setting.id];if(api.state('changesetStatus').get()&&(options&&options.unsaved)&&(_.isUndefined(settingRevision)||settingRevision<=api._lastSavedRevision)){return}values[setting.id]=setting.get()});return values};api.requestChangesetUpdate=function requestChangesetUpdate(changes,args){var deferred,request,submittedChanges={},data,submittedArgs;deferred=new $.Deferred();if(0!==api.state('processing').get()){deferred.reject('already_processing');return deferred.promise()}submittedArgs=_.extend({title:null,date:null,autosave:false,force:false},args);if(changes){_.extend(submittedChanges,changes)}_.each(api.dirtyValues({unsaved:true}),function(dirtyValue,settingId){if(!changes||null!==changes[settingId]){submittedChanges[settingId]=_.extend({},submittedChanges[settingId]||{},{value:dirtyValue})}});api.trigger('changeset-save',submittedChanges,submittedArgs);if(!submittedArgs.force&&_.isEmpty(submittedChanges)&&null===submittedArgs.title&&null===submittedArgs.date){deferred.resolve({});return deferred.promise()}if(submittedArgs.status){return deferred.reject({code:'illegal_status_in_changeset_update'}).promise()}if(submittedArgs.date&&submittedArgs.autosave){return deferred.reject({code:'illegal_autosave_with_date_gmt'}).promise()}api.state('processing').set(api.state('processing').get()+1);deferred.always(function(){api.state('processing').set(api.state('processing').get()-1)});data=api.previewer.query({excludeCustomizedSaved:true});delete data.customized;_.extend(data,{nonce:api.settings.nonce.save,customize_theme:api.settings.theme.stylesheet,customize_changeset_data:JSON.stringify(submittedChanges)});if(null!==submittedArgs.title){data.customize_changeset_title=submittedArgs.title}if(null!==submittedArgs.date){data.customize_changeset_date=submittedArgs.date}if(false!==submittedArgs.autosave){data.customize_changeset_autosave='true'}api.trigger('save-request-params',data);request=wp.ajax.post('customize_save',data);request.done(function requestChangesetUpdateDone(data){var savedChangesetValues={};api._lastSavedRevision=Math.max(api._latestRevision,api._lastSavedRevision);api.state('changesetStatus').set(data.changeset_status);if(data.changeset_date){api.state('changesetDate').set(data.changeset_date)}deferred.resolve(data);api.trigger('changeset-saved',data);if(data.setting_validities){_.each(data.setting_validities,function(validity,settingId){if(true===validity&&_.isObject(submittedChanges[settingId])&&!_.isUndefined(submittedChanges[settingId].value)){savedChangesetValues[settingId]=submittedChanges[settingId].value}})}api.previewer.send('changeset-saved',_.extend({},data,{saved_changeset_values:savedChangesetValues}))});request.fail(function requestChangesetUpdateFail(data){deferred.reject(data);api.trigger('changeset-error',data)});request.always(function(data){if(data.setting_validities){api._handleSettingValidities({settingValidities:data.setting_validities})}});return deferred.promise()};api.utils.bubbleChildValueChanges=function(instance,properties){$.each(properties,function(i,key){instance[key].bind(function(to,from){if(instance.parent&&to!==from){instance.parent.trigger('change',instance)}})})};focus=function(params){var construct,completeCallback,focus,focusElement;construct=this;params=params||{};focus=function(){var focusContainer;if((construct.extended(api.Panel)||construct.extended(api.Section))&&construct.expanded&&construct.expanded()){focusContainer=construct.contentContainer}else{focusContainer=construct.container}focusElement=focusContainer.find('.control-focus:first');if(0===focusElement.length){focusElement=focusContainer.find('input, select, textarea, button, object, a[href], [tabindex]').filter(':visible').first()}focusElement.focus()};if(params.completeCallback){completeCallback=params.completeCallback;params.completeCallback=function(){focus();completeCallback()}}else{params.completeCallback=focus}api.state('paneVisible').set(true);if(construct.expand){construct.expand(params)}else{params.completeCallback()}};api.utils.prioritySort=function(a,b){if(a.priority()===b.priority()&&typeof a.params.instanceNumber==='number'&&typeof b.params.instanceNumber==='number'){return a.params.instanceNumber-b.params.instanceNumber}else{return a.priority()-b.priority()}};api.utils.isKeydownButNotEnterEvent=function(event){return('keydown'===event.type&&13!==event.which)};api.utils.areElementListsEqual=function(listA,listB){var equal=(listA.length===listB.length&&-1===_.indexOf(_.map(_.zip(listA,listB),function(pair){return $(pair[0]).is(pair[1])}),false));return equal};api.utils.highlightButton=function highlightButton(button,options){var animationClass='button-see-me',canceled=false,params;params=_.extend({delay:0,focusTarget:button},options);function cancelReminder(){canceled=true}params.focusTarget.on('focusin',cancelReminder);setTimeout(function(){params.focusTarget.off('focusin',cancelReminder);if(!canceled){button.addClass(animationClass);button.one('animationend',function(){button.removeClass(animationClass)})}},params.delay);return cancelReminder};api.utils.getCurrentTimestamp=function getCurrentTimestamp(){var currentDate,currentClientTimestamp,timestampDifferential;currentClientTimestamp=_.now();currentDate=new Date(api.settings.initialServerDate.replace(/-/g,'/'));timestampDifferential=currentClientTimestamp-api.settings.initialClientTimestamp;timestampDifferential+=api.settings.initialClientTimestamp-api.settings.initialServerTimestamp;currentDate.setTime(currentDate.getTime()+timestampDifferential);return currentDate.getTime()};api.utils.getRemainingTime=function getRemainingTime(datetime){var millisecondsDivider=1000,remainingTime,timestamp;if(datetime instanceof Date){timestamp=datetime.getTime()}else if('string'===typeof datetime){timestamp=(new Date(datetime.replace(/-/g,'/'))).getTime()}else{timestamp=datetime}remainingTime=timestamp-api.utils.getCurrentTimestamp();remainingTime=Math.ceil(remainingTime/millisecondsDivider);return remainingTime};normalizedTransitionendEventName=(function(){var el,transitions,prop;el=document.createElement('div');transitions={'transition':'transitionend','OTransition':'oTransitionEnd','MozTransition':'transitionend','WebkitTransition':'webkitTransitionEnd'};prop=_.find(_.keys(transitions),function(prop){return!_.isUndefined(el.style[prop])});if(prop){return transitions[prop]}else{return null}})();Container=api.Class.extend({defaultActiveArguments:{duration:'fast',completeCallback:$.noop},defaultExpandedArguments:{duration:'fast',completeCallback:$.noop},containerType:'container',defaults:{title:'',description:'',priority:100,type:'default',content:null,active:true,instanceNumber:null},initialize:function(id,options){var container=this;container.id=id;if(!Container.instanceCounter){Container.instanceCounter=0}Container.instanceCounter++;$.extend(container,{params:_.defaults(options.params||options,container.defaults)});if(!container.params.instanceNumber){container.params.instanceNumber=Container.instanceCounter}container.notifications=new api.Notifications();container.templateSelector=container.params.templateId||'customize-'+container.containerType+'-'+container.params.type;container.container=$(container.params.content);if(0===container.container.length){container.container=$(container.getContainer())}container.headContainer=container.container;container.contentContainer=container.getContent();container.container=container.container.add(container.contentContainer);container.deferred={embedded:new $.Deferred()};container.priority=new api.Value();container.active=new api.Value();container.activeArgumentsQueue=[];container.expanded=new api.Value();container.expandedArgumentsQueue=[];container.active.bind(function(active){var args=container.activeArgumentsQueue.shift();args=$.extend({},container.defaultActiveArguments,args);active=(active&&container.isContextuallyActive());container.onChangeActive(active,args)});container.expanded.bind(function(expanded){var args=container.expandedArgumentsQueue.shift();args=$.extend({},container.defaultExpandedArguments,args);container.onChangeExpanded(expanded,args)});container.deferred.embedded.done(function(){container.setupNotifications();container.attachEvents()});api.utils.bubbleChildValueChanges(container,['priority','active']);container.priority.set(container.params.priority);container.active.set(container.params.active);container.expanded.set(false)},getNotificationsContainerElement:function(){var container=this;return container.contentContainer.find('.customize-control-notifications-container:first')},setupNotifications:function(){var container=this,renderNotifications;container.notifications.container=container.getNotificationsContainerElement();renderNotifications=function(){if(container.expanded.get()){container.notifications.render()}};container.expanded.bind(renderNotifications);renderNotifications();container.notifications.bind('change',_.debounce(renderNotifications))},ready:function(){},_children:function(parentType,childType){var parent=this,children=[];api[childType].each(function(child){if(child[parentType].get()===parent.id){children.push(child)}});children.sort(api.utils.prioritySort);return children},isContextuallyActive:function(){throw new Error('Container.isContextuallyActive() must be overridden in a subclass.');},onChangeActive:function(active,args){var construct=this,headContainer=construct.headContainer,duration,expandedOtherPanel;if(args.unchanged){if(args.completeCallback){args.completeCallback()}return}duration=('resolved'===api.previewer.deferred.active.state()?args.duration:0);if(construct.extended(api.Panel)){api.panel.each(function(panel){if(panel!==construct&&panel.expanded()){expandedOtherPanel=panel;duration=0}});if(!active){_.each(construct.sections(),function(section){section.collapse({duration:0})})}}if(!$.contains(document,headContainer.get(0))){headContainer.toggle(active);if(args.completeCallback){args.completeCallback()}}else if(active){headContainer.slideDown(duration,args.completeCallback)}else{if(construct.expanded()){construct.collapse({duration:duration,completeCallback:function(){headContainer.slideUp(duration,args.completeCallback)}})}else{headContainer.slideUp(duration,args.completeCallback)}}},_toggleActive:function(active,params){var self=this;params=params||{};if((active&&this.active.get())||(!active&&!this.active.get())){params.unchanged=true;self.onChangeActive(self.active.get(),params);return false}else{params.unchanged=false;this.activeArgumentsQueue.push(params);this.active.set(active);return true}},activate:function(params){return this._toggleActive(true,params)},deactivate:function(params){return this._toggleActive(false,params)},onChangeExpanded:function(){throw new Error('Must override with subclass.');},_toggleExpanded:function(expanded,params){var instance=this,previousCompleteCallback;params=params||{};previousCompleteCallback=params.completeCallback;if(expanded&&!instance.active()){return false}api.state('paneVisible').set(true);params.completeCallback=function(){if(previousCompleteCallback){previousCompleteCallback.apply(instance,arguments)}if(expanded){instance.container.trigger('expanded')}else{instance.container.trigger('collapsed')}};if((expanded&&instance.expanded.get())||(!expanded&&!instance.expanded.get())){params.unchanged=true;instance.onChangeExpanded(instance.expanded.get(),params);return false}else{params.unchanged=false;instance.expandedArgumentsQueue.push(params);instance.expanded.set(expanded);return true}},expand:function(params){return this._toggleExpanded(true,params)},collapse:function(params){return this._toggleExpanded(false,params)},_animateChangeExpanded:function(completeCallback){if(!normalizedTransitionendEventName){if(completeCallback){completeCallback()}return}var construct=this,content=construct.contentContainer,overlay=content.closest('.wp-full-overlay'),elements,transitionEndCallback,transitionParentPane;elements=overlay.add(content);if(!construct.panel||''===construct.panel()){transitionParentPane=true}else if(api.panel(construct.panel()).contentContainer.hasClass('skip-transition')){transitionParentPane=true}else{transitionParentPane=false}if(transitionParentPane){elements=elements.add('#customize-info, .customize-pane-parent')}transitionEndCallback=function(e){if(2!==e.eventPhase||!$(e.target).is(content)){return}content.off(normalizedTransitionendEventName,transitionEndCallback);elements.removeClass('busy');if(completeCallback){completeCallback()}};content.on(normalizedTransitionendEventName,transitionEndCallback);elements.addClass('busy');_.defer(function(){var container=content.closest('.wp-full-overlay-sidebar-content'),currentScrollTop=container.scrollTop(),previousScrollTop=content.data('previous-scrollTop')||0,expanded=construct.expanded();if(expanded&&0<currentScrollTop){content.css('top',currentScrollTop+'px');content.data('previous-scrollTop',currentScrollTop)}else if(!expanded&&0<currentScrollTop+previousScrollTop){content.css('top',previousScrollTop-currentScrollTop+'px');container.scrollTop(previousScrollTop)}})},focus:focus,getContainer:function(){var template,container=this;if(0!==$('#tmpl-'+container.templateSelector).length){template=wp.template(container.templateSelector)}else{template=wp.template('customize-'+container.containerType+'-default')}if(template&&container.container){return $.trim(template(_.extend({id:container.id},container.params)))}return'<li></li>'},getContent:function(){var construct=this,container=construct.container,content=container.find('.accordion-section-content, .control-panel-content').first(),contentId='sub-'+container.attr('id'),ownedElements=contentId,alreadyOwnedElements=container.attr('aria-owns');if(alreadyOwnedElements){ownedElements=ownedElements+' '+alreadyOwnedElements}container.attr('aria-owns',ownedElements);return content.detach().attr({'id':contentId,'class':'customize-pane-child '+content.attr('class')+' '+container.attr('class')})}});api.Section=Container.extend({containerType:'section',containerParent:'#customize-theme-controls',containerPaneParent:'.customize-pane-parent',defaults:{title:'',description:'',priority:100,type:'default',content:null,active:true,instanceNumber:null,panel:null,customizeAction:''},initialize:function(id,options){var section=this,params;params=options.params||options;if(!params.type){_.find(api.sectionConstructor,function(Constructor,type){if(Constructor===section.constructor){params.type=type;return true}return false})}Container.prototype.initialize.call(section,id,params);section.id=id;section.panel=new api.Value();section.panel.bind(function(id){$(section.headContainer).toggleClass('control-subsection',!!id)});section.panel.set(section.params.panel||'');api.utils.bubbleChildValueChanges(section,['panel']);section.embed();section.deferred.embedded.done(function(){section.ready()})},embed:function(){var inject,section=this;section.containerParent=api.ensure(section.containerParent);inject=function(panelId){var parentContainer;if(panelId){api.panel(panelId,function(panel){panel.deferred.embedded.done(function(){parentContainer=panel.contentContainer;if(!section.headContainer.parent().is(parentContainer)){parentContainer.append(section.headContainer)}if(!section.contentContainer.parent().is(section.headContainer)){section.containerParent.append(section.contentContainer)}section.deferred.embedded.resolve()})})}else{parentContainer=api.ensure(section.containerPaneParent);if(!section.headContainer.parent().is(parentContainer)){parentContainer.append(section.headContainer)}if(!section.contentContainer.parent().is(section.headContainer)){section.containerParent.append(section.contentContainer)}section.deferred.embedded.resolve()}};section.panel.bind(inject);inject(section.panel.get())},attachEvents:function(){var meta,content,section=this;if(section.container.hasClass('cannot-expand')){return}section.container.find('.accordion-section-title, .customize-section-back').on('click keydown',function(event){if(api.utils.isKeydownButNotEnterEvent(event)){return}event.preventDefault();if(section.expanded()){section.collapse()}else{section.expand()}});section.container.find('.customize-section-title .customize-help-toggle').on('click',function(){meta=section.container.find('.section-meta');if(meta.hasClass('cannot-expand')){return}content=meta.find('.customize-section-description:first');content.toggleClass('open');content.slideToggle(section.defaultExpandedArguments.duration,function(){content.trigger('toggled')});$(this).attr('aria-expanded',function(i,attr){return'true'===attr?'false':'true'})})},isContextuallyActive:function(){var section=this,controls=section.controls(),activeCount=0;_(controls).each(function(control){if(control.active()){activeCount+=1}});return(activeCount!==0)},controls:function(){return this._children('section','control')},onChangeExpanded:function(expanded,args){var section=this,container=section.headContainer.closest('.wp-full-overlay-sidebar-content'),content=section.contentContainer,overlay=section.headContainer.closest('.wp-full-overlay'),backBtn=content.find('.customize-section-back'),sectionTitle=section.headContainer.find('.accordion-section-title').first(),expand,panel;if(expanded&&!content.hasClass('open')){if(args.unchanged){expand=args.completeCallback}else{expand=$.proxy(function(){section._animateChangeExpanded(function(){sectionTitle.attr('tabindex','-1');backBtn.attr('tabindex','0');backBtn.focus();content.css('top','');container.scrollTop(0);if(args.completeCallback){args.completeCallback()}});content.addClass('open');overlay.addClass('section-open');api.state('expandedSection').set(section)},this)}if(!args.allowMultiple){api.section.each(function(otherSection){if(otherSection!==section){otherSection.collapse({duration:args.duration})}})}if(section.panel()){api.panel(section.panel()).expand({duration:args.duration,completeCallback:expand})}else{if(!args.allowMultiple){api.panel.each(function(panel){panel.collapse()})}expand()}}else if(!expanded&&content.hasClass('open')){if(section.panel()){panel=api.panel(section.panel());if(panel.contentContainer.hasClass('skip-transition')){panel.collapse()}}section._animateChangeExpanded(function(){backBtn.attr('tabindex','-1');sectionTitle.attr('tabindex','0');sectionTitle.focus();content.css('top','');if(args.completeCallback){args.completeCallback()}});content.removeClass('open');overlay.removeClass('section-open');if(section===api.state('expandedSection').get()){api.state('expandedSection').set(false)}}else{if(args.completeCallback){args.completeCallback()}}}});api.ThemesSection=api.Section.extend({currentTheme:'',overlay:'',template:'',screenshotQueue:null,$window:null,$body:null,loaded:0,loading:false,fullyLoaded:false,term:'',tags:'',nextTerm:'',nextTags:'',filtersHeight:0,headerContainer:null,updateCountDebounced:null,initialize:function(id,options){var section=this;section.headerContainer=$();section.$window=$(window);section.$body=$(document.body);api.Section.prototype.initialize.call(section,id,options);section.updateCountDebounced=_.debounce(section.updateCount,500)},embed:function(){var inject,section=this;inject=function(panelId){var parentContainer;api.panel(panelId,function(panel){panel.deferred.embedded.done(function(){parentContainer=panel.contentContainer;if(!section.headContainer.parent().is(parentContainer)){parentContainer.find('.customize-themes-full-container-container').before(section.headContainer)}if(!section.contentContainer.parent().is(section.headContainer)){section.containerParent.append(section.contentContainer)}section.deferred.embedded.resolve()})})};section.panel.bind(inject);inject(section.panel.get())},ready:function(){var section=this;section.overlay=section.container.find('.theme-overlay');section.template=wp.template('customize-themes-details-view');section.container.on('keydown',function(event){if(!section.overlay.find('.theme-wrap').is(':visible')){return}if(39===event.keyCode){section.nextTheme()}if(37===event.keyCode){section.previousTheme()}if(27===event.keyCode){if(section.$body.hasClass('modal-open')){section.closeDetails()}else{section.headerContainer.find('.customize-themes-section-title').focus()}event.stopPropagation()}});section.renderScreenshots=_.throttle(section.renderScreenshots,100);_.bindAll(section,'renderScreenshots','loadMore','checkTerm','filtersChecked')},isContextuallyActive:function(){return this.active()},attachEvents:function(){var section=this,debounced;section.container.find('.customize-section-back').on('click keydown',function(event){if(api.utils.isKeydownButNotEnterEvent(event)){return}event.preventDefault();section.collapse()});section.headerContainer=$('#accordion-section-'+section.id);section.headerContainer.on('click','.customize-themes-section-title',function(){if(section.headerContainer.find('.filter-details').length){section.headerContainer.find('.customize-themes-section-title').toggleClass('details-open').attr('aria-expanded',function(i,attr){return'true'===attr?'false':'true'});section.headerContainer.find('.filter-details').slideToggle(180)}if(!section.expanded()){section.expand()}});section.container.on('click','.theme-actions .preview-theme',function(){api.panel('themes').loadThemePreview($(this).data('slug'))});section.container.on('click','.left',function(){section.previousTheme()});section.container.on('click','.right',function(){section.nextTheme()});section.container.on('click','.theme-backdrop, .close',function(){section.closeDetails()});if('local'===section.params.filter_type){section.container.on('input','.wp-filter-search-themes',function(event){section.filterSearch(event.currentTarget.value)})}else if('remote'===section.params.filter_type){debounced=_.debounce(section.checkTerm,500);section.contentContainer.on('input','.wp-filter-search',function(){if(!api.panel('themes').expanded()){return}debounced(section);if(!section.expanded()){section.expand()}});section.contentContainer.on('click','.filter-group input',function(){section.filtersChecked();section.checkTerm(section)})}section.contentContainer.on('click','.feature-filter-toggle',function(e){var $themeContainer=$('.customize-themes-full-container'),$filterToggle=$(e.currentTarget);section.filtersHeight=$filterToggle.parent().next('.filter-drawer').height();if(0<$themeContainer.scrollTop()){$themeContainer.animate({scrollTop:0},400);if($filterToggle.hasClass('open')){return}}$filterToggle.toggleClass('open').attr('aria-expanded',function(i,attr){return'true'===attr?'false':'true'}).parent().next('.filter-drawer').slideToggle(180,'linear');if($filterToggle.hasClass('open')){var marginOffset=1018<window.innerWidth?50:76;section.contentContainer.find('.themes').css('margin-top',section.filtersHeight+marginOffset)}else{section.contentContainer.find('.themes').css('margin-top',0)}});section.contentContainer.on('click','.no-themes-local .search-dotorg-themes',function(){api.section('wporg_themes').focus()});function updateSelectedState(){var el=section.headerContainer.find('.customize-themes-section-title');el.toggleClass('selected',section.expanded());el.attr('aria-expanded',section.expanded()?'true':'false');if(!section.expanded()){el.removeClass('details-open')}}section.expanded.bind(updateSelectedState);updateSelectedState();api.bind('ready',function(){section.contentContainer=section.container.find('.customize-themes-section');section.contentContainer.appendTo($('.customize-themes-full-container'));section.container.add(section.headerContainer)})},onChangeExpanded:function(expanded,args){var section=this,container=section.contentContainer.closest('.customize-themes-full-container');if(args.unchanged){if(args.completeCallback){args.completeCallback()}return}function expand(){if(0===section.loaded){section.loadThemes()}api.section.each(function(otherSection){var searchTerm;if(otherSection!==section){if('themes'===otherSection.params.type){searchTerm=otherSection.contentContainer.find('.wp-filter-search').val();section.contentContainer.find('.wp-filter-search').val(searchTerm);if(''===searchTerm&&''!==section.term&&'local'!==section.params.filter_type){section.term='';section.initializeNewQuery(section.term,section.tags)}else{if('remote'===section.params.filter_type){section.checkTerm(section)}else if('local'===section.params.filter_type){section.filterSearch(searchTerm)}}otherSection.collapse({duration:args.duration})}}});section.contentContainer.addClass('current-section');container.scrollTop();container.on('scroll',_.throttle(section.renderScreenshots,300));container.on('scroll',_.throttle(section.loadMore,300));if(args.completeCallback){args.completeCallback()}section.updateCount()}if(expanded){if(section.panel()&&api.panel.has(section.panel())){api.panel(section.panel()).expand({duration:args.duration,completeCallback:expand})}else{expand()}}else{section.contentContainer.removeClass('current-section');section.headerContainer.find('.filter-details').slideUp(180);container.off('scroll');if(args.completeCallback){args.completeCallback()}}},getContent:function(){return this.container.find('.control-section-content')},loadThemes:function(){var section=this,params,page,request;if(section.loading){return}page=Math.ceil(section.loaded/100)+1;params={'nonce':api.settings.nonce.switch_themes,'wp_customize':'on','theme_action':section.params.action,'customized_theme':api.settings.theme.stylesheet,'page':page};if('remote'===section.params.filter_type){params.search=section.term;params.tags=section.tags}section.headContainer.closest('.wp-full-overlay').addClass('loading');section.loading=true;section.container.find('.no-themes').hide();request=wp.ajax.post('customize_load_themes',params);request.done(function(data){var themes=data.themes;if(''!==section.nextTerm||''!==section.nextTags){if(section.nextTerm){section.term=section.nextTerm}if(section.nextTags){section.tags=section.nextTags}section.nextTerm='';section.nextTags='';section.loading=false;section.loadThemes();return}if(0!==themes.length){section.loadControls(themes,page);if(1===page){_.each(section.controls().slice(0,3),function(control){var img,src=control.params.theme.screenshot[0];if(src){img=new Image();img.src=src}});if('local'!==section.params.filter_type){wp.a11y.speak(api.settings.l10n.themeSearchResults.replace('%d',data.info.results))}}_.delay(section.renderScreenshots,100);if('local'===section.params.filter_type||100>themes.length){section.fullyLoaded=true}}else{if(0===section.loaded){section.container.find('.no-themes').show();wp.a11y.speak(section.container.find('.no-themes').text())}else{section.fullyLoaded=true}}if('local'===section.params.filter_type){section.updateCount()}else{section.updateCount(data.info.results)}section.container.find('.unexpected-error').hide();section.headContainer.closest('.wp-full-overlay').removeClass('loading');section.loading=false});request.fail(function(data){if('undefined'===typeof data){section.container.find('.unexpected-error').show();wp.a11y.speak(section.container.find('.unexpected-error').text())}else if('undefined'!==typeof console&&console.error){console.error(data)}section.headContainer.closest('.wp-full-overlay').removeClass('loading');section.loading=false})},loadControls:function(themes,page){var newThemeControls=[],section=this;_.each(themes,function(theme){var themeControl=new api.controlConstructor.theme(section.params.action+'_theme_'+theme.id,{type:'theme',section:section.params.id,theme:theme,priority:section.loaded+1});api.control.add(themeControl);newThemeControls.push(themeControl);section.loaded=section.loaded+1});if(1!==page){Array.prototype.push.apply(section.screenshotQueue,newThemeControls)}},loadMore:function(){var section=this,container,bottom,threshold;if(!section.fullyLoaded&&!section.loading){container=section.container.closest('.customize-themes-full-container');bottom=container.scrollTop()+container.height();threshold=container.prop('scrollHeight')-3000;if(bottom>threshold){section.loadThemes()}}},filterSearch:function(term){var count=0,visible=false,section=this,noFilter=(api.section.has('wporg_themes')&&'remote'!==section.params.filter_type)?'.no-themes-local':'.no-themes',controls=section.controls(),terms;if(section.loading){return}terms=term.toLowerCase().trim().replace(/-/g,' ').split(' ');_.each(controls,function(control){visible=control.filter(terms);if(visible){count=count+1}});if(0===count){section.container.find(noFilter).show();wp.a11y.speak(section.container.find(noFilter).text())}else{section.container.find(noFilter).hide()}section.renderScreenshots();api.reflowPaneContents();section.updateCountDebounced(count)},checkTerm:function(section){var newTerm;if('remote'===section.params.filter_type){newTerm=section.contentContainer.find('.wp-filter-search').val();if(section.term!==newTerm.trim()){section.initializeNewQuery(newTerm,section.tags)}}},filtersChecked:function(){var section=this,items=section.container.find('.filter-group').find(':checkbox'),tags=[];_.each(items.filter(':checked'),function(item){tags.push($(item).prop('value'))});if(0===tags.length){tags='';section.contentContainer.find('.feature-filter-toggle .filter-count-0').show();section.contentContainer.find('.feature-filter-toggle .filter-count-filters').hide()}else{section.contentContainer.find('.feature-filter-toggle .theme-filter-count').text(tags.length);section.contentContainer.find('.feature-filter-toggle .filter-count-0').hide();section.contentContainer.find('.feature-filter-toggle .filter-count-filters').show()}if(!_.isEqual(section.tags,tags)){if(section.loading){section.nextTags=tags}else{if('remote'===section.params.filter_type){section.initializeNewQuery(section.term,tags)}else if('local'===section.params.filter_type){section.filterSearch(tags.join(' '))}}}},initializeNewQuery:function(newTerm,newTags){var section=this;_.each(section.controls(),function(control){control.container.remove();api.control.remove(control.id)});section.loaded=0;section.fullyLoaded=false;section.screenshotQueue=null;if(!section.loading){section.term=newTerm;section.tags=newTags;section.loadThemes()}else{section.nextTerm=newTerm;section.nextTags=newTags}if(!section.expanded()){section.expand()}},renderScreenshots:function(){var section=this;if(null===section.screenshotQueue||0===section.screenshotQueue.length){section.screenshotQueue=_.filter(section.controls(),function(control){return!control.screenshotRendered})}if(!section.screenshotQueue.length){return}section.screenshotQueue=_.filter(section.screenshotQueue,function(control){var $imageWrapper=control.container.find('.theme-screenshot'),$image=$imageWrapper.find('img');if(!$image.length){return false}if($image.is(':hidden')){return true}var wt=section.$window.scrollTop(),wb=wt+section.$window.height(),et=$image.offset().top,ih=$imageWrapper.height(),eb=et+ih,threshold=ih*3,inView=eb>=wt-threshold&&et<=wb+threshold;if(inView){control.container.trigger('render-screenshot')}return!inView})},getVisibleCount:function(){return this.contentContainer.find('li.customize-control:visible').length},updateCount:function(count){var section=this,countEl,displayed;if(!count&&0!==count){count=section.getVisibleCount()}displayed=section.contentContainer.find('.themes-displayed');countEl=section.contentContainer.find('.theme-count');if(0===count){countEl.text('0')}else{displayed.fadeOut(180,function(){countEl.text(count);displayed.fadeIn(180)});wp.a11y.speak(api.settings.l10n.announceThemeCount.replace('%d',count))}},nextTheme:function(){var section=this;if(section.getNextTheme()){section.showDetails(section.getNextTheme(),function(){section.overlay.find('.right').focus()})}},getNextTheme:function(){var section=this,control,nextControl,sectionControls,i;control=api.control(section.params.action+'_theme_'+section.currentTheme);sectionControls=section.controls();i=_.indexOf(sectionControls,control);if(-1===i){return false}nextControl=sectionControls[i+1];if(!nextControl){return false}return nextControl.params.theme},previousTheme:function(){var section=this;if(section.getPreviousTheme()){section.showDetails(section.getPreviousTheme(),function(){section.overlay.find('.left').focus()})}},getPreviousTheme:function(){var section=this,control,nextControl,sectionControls,i;control=api.control(section.params.action+'_theme_'+section.currentTheme);sectionControls=section.controls();i=_.indexOf(sectionControls,control);if(-1===i){return false}nextControl=sectionControls[i-1];if(!nextControl){return false}return nextControl.params.theme},updateLimits:function(){if(!this.getNextTheme()){this.overlay.find('.right').addClass('disabled')}if(!this.getPreviousTheme()){this.overlay.find('.left').addClass('disabled')}},loadThemePreview:function(themeId){return api.ThemesPanel.prototype.loadThemePreview.call(this,themeId)},showDetails:function(theme,callback){var section=this,panel=api.panel('themes');section.currentTheme=theme.id;section.overlay.html(section.template(theme)).fadeIn('fast').focus();function disableSwitchButtons(){return!panel.canSwitchTheme(theme.id)}function disableInstallButtons(){return disableSwitchButtons()||false===api.settings.theme._canInstall||true===api.settings.theme._filesystemCredentialsNeeded}section.overlay.find('button.preview, button.preview-theme').toggleClass('disabled',disableSwitchButtons());section.overlay.find('button.theme-install').toggleClass('disabled',disableInstallButtons());section.$body.addClass('modal-open');section.containFocus(section.overlay);section.updateLimits();wp.a11y.speak(api.settings.l10n.announceThemeDetails.replace('%s',theme.name));if(callback){callback()}},closeDetails:function(){var section=this;section.$body.removeClass('modal-open');section.overlay.fadeOut('fast');api.control(section.params.action+'_theme_'+section.currentTheme).container.find('.theme').focus()},containFocus:function(el){var tabbables;el.on('keydown',function(event){if(9!==event.keyCode){return}tabbables=$(':tabbable',el);if(tabbables.last()[0]===event.target&&!event.shiftKey){tabbables.first().focus();return false}else if(tabbables.first()[0]===event.target&&event.shiftKey){tabbables.last().focus();return false}})}});api.OuterSection=api.Section.extend({initialize:function(){var section=this;section.containerParent='#customize-outer-theme-controls';section.containerPaneParent='.customize-outer-pane-parent';api.Section.prototype.initialize.apply(section,arguments)},onChangeExpanded:function(expanded,args){var section=this,container=section.headContainer.closest('.wp-full-overlay-sidebar-content'),content=section.contentContainer,backBtn=content.find('.customize-section-back'),sectionTitle=section.headContainer.find('.accordion-section-title').first(),body=$(document.body),expand,panel;body.toggleClass('outer-section-open',expanded);section.container.toggleClass('open',expanded);section.container.removeClass('busy');api.section.each(function(_section){if('outer'===_section.params.type&&_section.id!==section.id){_section.container.removeClass('open')}});if(expanded&&!content.hasClass('open')){if(args.unchanged){expand=args.completeCallback}else{expand=$.proxy(function(){section._animateChangeExpanded(function(){sectionTitle.attr('tabindex','-1');backBtn.attr('tabindex','0');backBtn.focus();content.css('top','');container.scrollTop(0);if(args.completeCallback){args.completeCallback()}});content.addClass('open')},this)}if(section.panel()){api.panel(section.panel()).expand({duration:args.duration,completeCallback:expand})}else{expand()}}else if(!expanded&&content.hasClass('open')){if(section.panel()){panel=api.panel(section.panel());if(panel.contentContainer.hasClass('skip-transition')){panel.collapse()}}section._animateChangeExpanded(function(){backBtn.attr('tabindex','-1');sectionTitle.attr('tabindex','0');sectionTitle.focus();content.css('top','');if(args.completeCallback){args.completeCallback()}});content.removeClass('open')}else{if(args.completeCallback){args.completeCallback()}}}});api.Panel=Container.extend({containerType:'panel',initialize:function(id,options){var panel=this,params;params=options.params||options;if(!params.type){_.find(api.panelConstructor,function(Constructor,type){if(Constructor===panel.constructor){params.type=type;return true}return false})}Container.prototype.initialize.call(panel,id,params);panel.embed();panel.deferred.embedded.done(function(){panel.ready()})},embed:function(){var panel=this,container=$('#customize-theme-controls'),parentContainer=$('.customize-pane-parent');if(!panel.headContainer.parent().is(parentContainer)){parentContainer.append(panel.headContainer)}if(!panel.contentContainer.parent().is(panel.headContainer)){container.append(panel.contentContainer)}panel.renderContent();panel.deferred.embedded.resolve()},attachEvents:function(){var meta,panel=this;panel.headContainer.find('.accordion-section-title').on('click keydown',function(event){if(api.utils.isKeydownButNotEnterEvent(event)){return}event.preventDefault();if(!panel.expanded()){panel.expand()}});panel.container.find('.customize-panel-back').on('click keydown',function(event){if(api.utils.isKeydownButNotEnterEvent(event)){return}event.preventDefault();if(panel.expanded()){panel.collapse()}});meta=panel.container.find('.panel-meta:first');meta.find('> .accordion-section-title .customize-help-toggle').on('click',function(){if(meta.hasClass('cannot-expand')){return}var content=meta.find('.customize-panel-description:first');if(meta.hasClass('open')){meta.toggleClass('open');content.slideUp(panel.defaultExpandedArguments.duration,function(){content.trigger('toggled')});$(this).attr('aria-expanded',false)}else{content.slideDown(panel.defaultExpandedArguments.duration,function(){content.trigger('toggled')});meta.toggleClass('open');$(this).attr('aria-expanded',true)}})},sections:function(){return this._children('panel','section')},isContextuallyActive:function(){var panel=this,sections=panel.sections(),activeCount=0;_(sections).each(function(section){if(section.active()&&section.isContextuallyActive()){activeCount+=1}});return(activeCount!==0)},onChangeExpanded:function(expanded,args){if(args.unchanged){if(args.completeCallback){args.completeCallback()}return}var panel=this,accordionSection=panel.contentContainer,overlay=accordionSection.closest('.wp-full-overlay'),container=accordionSection.closest('.wp-full-overlay-sidebar-content'),topPanel=panel.headContainer.find('.accordion-section-title'),backBtn=accordionSection.find('.customize-panel-back'),childSections=panel.sections(),skipTransition;if(expanded&&!accordionSection.hasClass('current-panel')){api.section.each(function(section){if(panel.id!==section.panel()){section.collapse({duration:0})}});api.panel.each(function(otherPanel){if(panel!==otherPanel){otherPanel.collapse({duration:0})}});if(panel.params.autoExpandSoleSection&&1===childSections.length&&childSections[0].active.get()){accordionSection.addClass('current-panel skip-transition');overlay.addClass('in-sub-panel');childSections[0].expand({completeCallback:args.completeCallback})}else{panel._animateChangeExpanded(function(){topPanel.attr('tabindex','-1');backBtn.attr('tabindex','0');backBtn.focus();accordionSection.css('top','');container.scrollTop(0);if(args.completeCallback){args.completeCallback()}});accordionSection.addClass('current-panel');overlay.addClass('in-sub-panel')}api.state('expandedPanel').set(panel)}else if(!expanded&&accordionSection.hasClass('current-panel')){skipTransition=accordionSection.hasClass('skip-transition');if(!skipTransition){panel._animateChangeExpanded(function(){topPanel.attr('tabindex','0');backBtn.attr('tabindex','-1');topPanel.focus();accordionSection.css('top','');if(args.completeCallback){args.completeCallback()}})}else{accordionSection.removeClass('skip-transition')}overlay.removeClass('in-sub-panel');accordionSection.removeClass('current-panel');if(panel===api.state('expandedPanel').get()){api.state('expandedPanel').set(false)}}},renderContent:function(){var template,panel=this;if(0!==$('#tmpl-'+panel.templateSelector+'-content').length){template=wp.template(panel.templateSelector+'-content')}else{template=wp.template('customize-panel-default-content')}if(template&&panel.headContainer){panel.contentContainer.html(template(_.extend({id:panel.id},panel.params)))}}});api.ThemesPanel=api.Panel.extend({initialize:function(id,options){var panel=this;panel.installingThemes=[];api.Panel.prototype.initialize.call(panel,id,options)},canSwitchTheme:function canSwitchTheme(slug){if(slug&&slug===api.settings.theme.stylesheet){return true}return'publish'===api.state('selectedChangesetStatus').get()&&(''===api.state('changesetStatus').get()||'auto-draft'===api.state('changesetStatus').get())},attachEvents:function(){var panel=this;api.Panel.prototype.attachEvents.apply(panel);if(api.settings.theme._canInstall&&api.settings.theme._filesystemCredentialsNeeded){panel.notifications.add(new api.Notification('theme_install_unavailable',{message:api.l10n.themeInstallUnavailable,type:'info',dismissible:true}))}function toggleDisabledNotifications(){if(panel.canSwitchTheme()){panel.notifications.remove('theme_switch_unavailable')}else{panel.notifications.add(new api.Notification('theme_switch_unavailable',{message:api.l10n.themePreviewUnavailable,type:'warning'}))}}toggleDisabledNotifications();api.state('selectedChangesetStatus').bind(toggleDisabledNotifications);api.state('changesetStatus').bind(toggleDisabledNotifications);panel.contentContainer.on('click','.customize-theme',function(){panel.collapse()});panel.contentContainer.on('click','.customize-themes-section-title, .customize-themes-mobile-back',function(){$('.wp-full-overlay').toggleClass('showing-themes')});panel.contentContainer.on('click','.theme-install',function(event){panel.installTheme(event)});panel.contentContainer.on('click','.update-theme, #update-theme',function(event){event.preventDefault();event.stopPropagation();panel.updateTheme(event)});panel.contentContainer.on('click','.delete-theme',function(event){panel.deleteTheme(event)});_.bindAll(panel,'installTheme','updateTheme')},onChangeExpanded:function(expanded,args){var panel=this,overlay,sections,hasExpandedSection=false;api.Panel.prototype.onChangeExpanded.apply(this,[expanded,args]);if(args.unchanged){if(args.completeCallback){args.completeCallback()}return}overlay=panel.headContainer.closest('.wp-full-overlay');if(expanded){overlay.addClass('in-themes-panel').delay(200).find('.customize-themes-full-container').addClass('animate');_.delay(function(){overlay.addClass('themes-panel-expanded')},200);if(600<window.innerWidth){sections=panel.sections();_.each(sections,function(section){if(section.expanded()){hasExpandedSection=true}});if(!hasExpandedSection&&sections.length>0){sections[0].expand()}}}else{overlay.removeClass('in-themes-panel themes-panel-expanded').find('.customize-themes-full-container').removeClass('animate')}},installTheme:function(event){var panel=this,preview,onInstallSuccess,slug=$(event.target).data('slug'),deferred=$.Deferred(),request;preview=$(event.target).hasClass('preview');if(api.settings.theme._filesystemCredentialsNeeded){deferred.reject({errorCode:'theme_install_unavailable'});return deferred.promise()}if(!panel.canSwitchTheme(slug)){deferred.reject({errorCode:'theme_switch_unavailable'});return deferred.promise()}if(_.contains(panel.installingThemes,slug)){deferred.reject({errorCode:'theme_already_installing'});return deferred.promise()}wp.updates.maybeRequestFilesystemCredentials(event);onInstallSuccess=function(response){var theme=false,themeControl;if(preview){api.notifications.remove('theme_installing');panel.loadThemePreview(slug)}else{api.control.each(function(control){if('theme'===control.params.type&&control.params.theme.id===response.slug){theme=control.params.theme;control.rerenderAsInstalled(true)}});if(!theme||api.control.has('installed_theme_'+theme.id)){deferred.resolve(response);return}theme.type='installed';themeControl=new api.controlConstructor.theme('installed_theme_'+theme.id,{type:'theme',section:'installed_themes',theme:theme,priority:0});api.control.add(themeControl);api.control(themeControl.id).container.trigger('render-screenshot');api.section.each(function(section){if('themes'===section.params.type){if(theme.id===section.currentTheme){section.closeDetails()}}})}deferred.resolve(response)};panel.installingThemes.push(slug);request=wp.updates.installTheme({slug:slug});if(preview){api.notifications.add(new api.OverlayNotification('theme_installing',{message:api.l10n.themeDownloading,type:'info',loading:true}))}request.done(onInstallSuccess);request.fail(function(){api.notifications.remove('theme_installing')});return deferred.promise()},loadThemePreview:function(themeId){var panel=this,deferred=$.Deferred(),onceProcessingComplete,urlParser,queryParams;if(!panel.canSwitchTheme(themeId)){deferred.reject({errorCode:'theme_switch_unavailable'});return deferred.promise()}urlParser=document.createElement('a');urlParser.href=location.href;queryParams=_.extend(api.utils.parseQueryString(urlParser.search.substr(1)),{theme:themeId,changeset_uuid:api.settings.changeset.uuid,'return':api.settings.url['return']});if(!api.state('saved').get()){queryParams.customize_autosaved='on'}urlParser.search=$.param(queryParams);api.notifications.add(new api.OverlayNotification('theme_previewing',{message:api.l10n.themePreviewWait,type:'info',loading:true}));onceProcessingComplete=function(){var request;if(api.state('processing').get()>0){return}api.state('processing').unbind(onceProcessingComplete);request=api.requestChangesetUpdate({},{autosave:true});request.done(function(){deferred.resolve();$(window).off('beforeunload.customize-confirm');location.replace(urlParser.href)});request.fail(function(){api.notifications.remove('theme_previewing');deferred.reject()})};if(0===api.state('processing').get()){onceProcessingComplete()}else{api.state('processing').bind(onceProcessingComplete)}return deferred.promise()},updateTheme:function(event){wp.updates.maybeRequestFilesystemCredentials(event);$(document).one('wp-theme-update-success',function(e,response){api.control.each(function(control){if('theme'===control.params.type&&control.params.theme.id===response.slug){control.params.theme.hasUpdate=false;control.params.theme.version=response.newVersion;setTimeout(function(){control.rerenderAsInstalled(true)},2000)}})});wp.updates.updateTheme({slug:$(event.target).closest('.notice').data('slug')})},deleteTheme:function(event){var theme,section;theme=$(event.target).data('slug');section=api.section('installed_themes');event.preventDefault();if(api.settings.theme._filesystemCredentialsNeeded){return}if(!window.confirm(api.settings.l10n.confirmDeleteTheme)){return}wp.updates.maybeRequestFilesystemCredentials(event);$(document).one('wp-theme-delete-success',function(){var control=api.control('installed_theme_'+theme);control.container.remove();api.control.remove(control.id);section.loaded=section.loaded-1;section.updateCount();api.control.each(function(control){if('theme'===control.params.type&&control.params.theme.id===theme){control.rerenderAsInstalled(false)}})});wp.updates.deleteTheme({slug:theme});section.closeDetails();section.focus()}});api.Control=api.Class.extend({defaultActiveArguments:{duration:'fast',completeCallback:$.noop},defaults:{label:'',description:'',active:true,priority:10},initialize:function(id,options){var control=this,deferredSettingIds=[],settings,gatherSettings;control.params=_.extend({},control.defaults,control.params||{},options.params||options||{});if(!api.Control.instanceCounter){api.Control.instanceCounter=0}api.Control.instanceCounter++;if(!control.params.instanceNumber){control.params.instanceNumber=api.Control.instanceCounter}if(!control.params.type){_.find(api.controlConstructor,function(Constructor,type){if(Constructor===control.constructor){control.params.type=type;return true}return false})}if(!control.params.content){control.params.content=$('<li></li>',{id:'customize-control-'+id.replace(/]/g,'').replace(/\[/g,'-'),'class':'customize-control customize-control-'+control.params.type})}control.id=id;control.selector='#customize-control-'+id.replace(/\]/g,'').replace(/\[/g,'-');if(control.params.content){control.container=$(control.params.content)}else{control.container=$(control.selector)}if(control.params.templateId){control.templateSelector=control.params.templateId}else{control.templateSelector='customize-control-'+control.params.type+'-content'}control.deferred=_.extend(control.deferred||{},{embedded:new $.Deferred()});control.section=new api.Value();control.priority=new api.Value();control.active=new api.Value();control.activeArgumentsQueue=[];control.notifications=new api.Notifications({alt:control.altNotice});control.elements=[];control.active.bind(function(active){var args=control.activeArgumentsQueue.shift();args=$.extend({},control.defaultActiveArguments,args);control.onChangeActive(active,args)});control.section.set(control.params.section);control.priority.set(isNaN(control.params.priority)?10:control.params.priority);control.active.set(control.params.active);api.utils.bubbleChildValueChanges(control,['section','priority','active']);control.settings={};settings={};if(control.params.setting){settings['default']=control.params.setting}_.extend(settings,control.params.settings);_.each(settings,function(value,key){var setting;if(_.isObject(value)&&_.isFunction(value.extended)&&value.extended(api.Value)){control.settings[key]=value}else if(_.isString(value)){setting=api(value);if(setting){control.settings[key]=setting}else{deferredSettingIds.push(value)}}});gatherSettings=function(){_.each(settings,function(settingId,key){if(!control.settings[key]&&_.isString(settingId)){control.settings[key]=api(settingId)}});if(control.settings[0]&&!control.settings['default']){control.settings['default']=control.settings[0]}control.setting=control.settings['default']||null;control.linkElements();control.embed()};if(0===deferredSettingIds.length){gatherSettings()}else{api.apply(api,deferredSettingIds.concat(gatherSettings))}control.deferred.embedded.done(function(){control.linkElements();control.setupNotifications();control.ready()})},linkElements:function(){var control=this,nodes,radios,element;nodes=control.container.find('[data-customize-setting-link], [data-customize-setting-key-link]');radios={};nodes.each(function(){var node=$(this),name,setting;if(node.data('customizeSettingLinked')){return}node.data('customizeSettingLinked',true);if(node.is(':radio')){name=node.prop('name');if(radios[name]){return}radios[name]=true;node=nodes.filter('[name="'+name+'"]')}if(node.data('customizeSettingLink')){setting=api(node.data('customizeSettingLink'))}else if(node.data('customizeSettingKeyLink')){setting=control.settings[node.data('customizeSettingKeyLink')]}if(setting){element=new api.Element(node);control.elements.push(element);element.sync(setting);element.set(setting())}})},embed:function(){var control=this,inject;inject=function(sectionId){var parentContainer;if(!sectionId){return}api.section(sectionId,function(section){section.deferred.embedded.done(function(){parentContainer=(section.contentContainer.is('ul'))?section.contentContainer:section.contentContainer.find('ul:first');if(!control.container.parent().is(parentContainer)){parentContainer.append(control.container);control.renderContent()}control.deferred.embedded.resolve()})})};control.section.bind(inject);inject(control.section.get())},ready:function(){var control=this,newItem;if('dropdown-pages'===control.params.type&&control.params.allow_addition){newItem=control.container.find('.new-content-item');newItem.hide();control.container.on('click','.add-new-toggle',function(e){$(e.currentTarget).slideUp(180);newItem.slideDown(180);newItem.find('.create-item-input').focus()});control.container.on('click','.add-content',function(){control.addNewPage()});control.container.on('keydown','.create-item-input',function(e){if(13===e.which){control.addNewPage()}})}},getNotificationsContainerElement:function(){var control=this,controlTitle,notificationsContainer;notificationsContainer=control.container.find('.customize-control-notifications-container:first');if(notificationsContainer.length){return notificationsContainer}notificationsContainer=$('<div class="customize-control-notifications-container"></div>');if(control.container.hasClass('customize-control-nav_menu_item')){control.container.find('.menu-item-settings:first').prepend(notificationsContainer)}else if(control.container.hasClass('customize-control-widget_form')){control.container.find('.widget-inside:first').prepend(notificationsContainer)}else{controlTitle=control.container.find('.customize-control-title');if(controlTitle.length){controlTitle.after(notificationsContainer)}else{control.container.prepend(notificationsContainer)}}return notificationsContainer},setupNotifications:function(){var control=this,renderNotificationsIfVisible,onSectionAssigned;_.each(control.settings,function(setting){if(!setting.notifications){return}setting.notifications.bind('add',function(settingNotification){var params=_.extend({},settingNotification,{setting:setting.id});control.notifications.add(new api.Notification(setting.id+':'+settingNotification.code,params))});setting.notifications.bind('remove',function(settingNotification){control.notifications.remove(setting.id+':'+settingNotification.code)})});renderNotificationsIfVisible=function(){var sectionId=control.section();if(!sectionId||(api.section.has(sectionId)&&api.section(sectionId).expanded())){control.notifications.render()}};control.notifications.bind('rendered',function(){var notifications=control.notifications.get();control.container.toggleClass('has-notifications',0!==notifications.length);control.container.toggleClass('has-error',0!==_.where(notifications,{type:'error'}).length)});onSectionAssigned=function(newSectionId,oldSectionId){if(oldSectionId&&api.section.has(oldSectionId)){api.section(oldSectionId).expanded.unbind(renderNotificationsIfVisible)}if(newSectionId){api.section(newSectionId,function(section){section.expanded.bind(renderNotificationsIfVisible);renderNotificationsIfVisible()})}};control.section.bind(onSectionAssigned);onSectionAssigned(control.section.get());control.notifications.bind('change',_.debounce(renderNotificationsIfVisible))},renderNotifications:function(){var control=this,container,notifications,hasError=false;if('undefined'!==typeof console&&console.warn){console.warn('[DEPRECATED] wp.customize.Control.prototype.renderNotifications() is deprecated in favor of instantating a wp.customize.Notifications and calling its render() method.')}container=control.getNotificationsContainerElement();if(!container||!container.length){return}notifications=[];control.notifications.each(function(notification){notifications.push(notification);if('error'===notification.type){hasError=true}});if(0===notifications.length){container.stop().slideUp('fast')}else{container.stop().slideDown('fast',null,function(){$(this).css('height','auto')})}if(!control.notificationsTemplate){control.notificationsTemplate=wp.template('customize-control-notifications')}control.container.toggleClass('has-notifications',0!==notifications.length);control.container.toggleClass('has-error',hasError);container.empty().append($.trim(control.notificationsTemplate({notifications:notifications,altNotice:Boolean(control.altNotice)})))},expand:function(params){api.section(this.section()).expand(params)},focus:focus,onChangeActive:function(active,args){if(args.unchanged){if(args.completeCallback){args.completeCallback()}return}if(!$.contains(document,this.container[0])){this.container.toggle(active);if(args.completeCallback){args.completeCallback()}}else if(active){this.container.slideDown(args.duration,args.completeCallback)}else{this.container.slideUp(args.duration,args.completeCallback)}},toggle:function(active){return this.onChangeActive(active,this.defaultActiveArguments)},activate:Container.prototype.activate,deactivate:Container.prototype.deactivate,_toggleActive:Container.prototype._toggleActive,dropdownInit:function(){var control=this,statuses=this.container.find('.dropdown-status'),params=this.params,toggleFreeze=false,update=function(to){if('string'===typeof to&&params.statuses&&params.statuses[to]){statuses.html(params.statuses[to]).show()}else{statuses.hide()}};this.container.on('click keydown','.dropdown',function(event){if(api.utils.isKeydownButNotEnterEvent(event)){return}event.preventDefault();if(!toggleFreeze){control.container.toggleClass('open')}if(control.container.hasClass('open')){control.container.parent().parent().find('li.library-selected').focus()}toggleFreeze=true;setTimeout(function(){toggleFreeze=false},400)});this.setting.bind(update);update(this.setting())},renderContent:function(){var control=this,template,standardTypes,templateId,sectionId;standardTypes=['button','checkbox','date','datetime-local','email','month','number','password','radio','range','search','select','tel','time','text','textarea','week','url'];templateId=control.templateSelector;if(templateId==='customize-control-'+control.params.type+'-content'&&_.contains(standardTypes,control.params.type)&&!document.getElementById('tmpl-'+templateId)&&0===control.container.children().length){templateId='customize-control-default-content'}if(document.getElementById('tmpl-'+templateId)){template=wp.template(templateId);if(template&&control.container){control.container.html(template(control.params))}}control.notifications.container=control.getNotificationsContainerElement();sectionId=control.section();if(!sectionId||(api.section.has(sectionId)&&api.section(sectionId).expanded())){control.notifications.render()}},addNewPage:function(){var control=this,promise,toggle,container,input,title,select;if('dropdown-pages'!==control.params.type||!control.params.allow_addition||!api.Menus){return}toggle=control.container.find('.add-new-toggle');container=control.container.find('.new-content-item');input=control.container.find('.create-item-input');title=input.val();select=control.container.find('select');if(!title){input.addClass('invalid');return}input.removeClass('invalid');input.attr('disabled','disabled');promise=api.Menus.insertAutoDraftPost({post_title:title,post_type:'page'});promise.done(function(data){var availableItem,$content,itemTemplate;availableItem=new api.Menus.AvailableItemModel({'id':'post-'+data.post_id,'title':title,'type':'post_type','type_label':api.Menus.data.l10n.page_label,'object':'page','object_id':data.post_id,'url':data.url});api.Menus.availableMenuItemsPanel.collection.add(availableItem);$content=$('#available-menu-items-post_type-page').find('.available-menu-items-list');itemTemplate=wp.template('available-menu-item');$content.prepend(itemTemplate(availableItem.attributes));select.focus();control.setting.set(String(data.post_id));container.slideUp(180);toggle.slideDown(180)});promise.always(function(){input.val('').removeAttr('disabled')})}});api.ColorControl=api.Control.extend({ready:function(){var control=this,isHueSlider=this.params.mode==='hue',updating=false,picker;if(isHueSlider){picker=this.container.find('.color-picker-hue');picker.val(control.setting()).wpColorPicker({change:function(event,ui){updating=true;control.setting(ui.color.h());updating=false}})}else{picker=this.container.find('.color-picker-hex');picker.val(control.setting()).wpColorPicker({change:function(){updating=true;control.setting.set(picker.wpColorPicker('color'));updating=false},clear:function(){updating=true;control.setting.set('');updating=false}})}control.setting.bind(function(value){if(updating){return}picker.val(value);picker.wpColorPicker('color',value)});control.container.on('keydown',function(event){var pickerContainer;if(27!==event.which){return}pickerContainer=control.container.find('.wp-picker-container');if(pickerContainer.hasClass('wp-picker-active')){picker.wpColorPicker('close');control.container.find('.wp-color-result').focus();event.stopPropagation()}})}});api.MediaControl=api.Control.extend({ready:function(){var control=this;_.bindAll(control,'restoreDefault','removeFile','openFrame','select','pausePlayer');control.container.on('click keydown','.upload-button',control.openFrame);control.container.on('click keydown','.upload-button',control.pausePlayer);control.container.on('click keydown','.thumbnail-image img',control.openFrame);control.container.on('click keydown','.default-button',control.restoreDefault);control.container.on('click keydown','.remove-button',control.pausePlayer);control.container.on('click keydown','.remove-button',control.removeFile);control.container.on('click keydown','.remove-button',control.cleanupPlayer);api.section(control.section()).container.on('expanded',function(){if(control.player){control.player.setControlsSize()}}).on('collapsed',function(){control.pausePlayer()});function setAttachmentDataAndRenderContent(value){var hasAttachmentData=$.Deferred();if(control.extended(api.UploadControl)){hasAttachmentData.resolve()}else{value=parseInt(value,10);if(_.isNaN(value)||value<=0){delete control.params.attachment;hasAttachmentData.resolve()}else if(control.params.attachment&&control.params.attachment.id===value){hasAttachmentData.resolve()}}if('pending'===hasAttachmentData.state()){wp.media.attachment(value).fetch().done(function(){control.params.attachment=this.attributes;hasAttachmentData.resolve();wp.customize.previewer.send(control.setting.id+'-attachment-data',this.attributes)})}hasAttachmentData.done(function(){control.renderContent()})}setAttachmentDataAndRenderContent(control.setting());control.setting.bind(setAttachmentDataAndRenderContent)},pausePlayer:function(){this.player&&this.player.pause()},cleanupPlayer:function(){this.player&&wp.media.mixin.removePlayer(this.player)},openFrame:function(event){if(api.utils.isKeydownButNotEnterEvent(event)){return}event.preventDefault();if(!this.frame){this.initFrame()}this.frame.open()},initFrame:function(){this.frame=wp.media({button:{text:this.params.button_labels.frame_button},states:[new wp.media.controller.Library({title:this.params.button_labels.frame_title,library:wp.media.query({type:this.params.mime_type}),multiple:false,date:false})]});this.frame.on('select',this.select)},select:function(){var node,attachment=this.frame.state().get('selection').first().toJSON(),mejsSettings=window._wpmejsSettings||{};this.params.attachment=attachment;this.setting(attachment.id);node=this.container.find('audio, video').get(0);if(node){this.player=new MediaElementPlayer(node,mejsSettings)}else{this.cleanupPlayer()}},restoreDefault:function(event){if(api.utils.isKeydownButNotEnterEvent(event)){return}event.preventDefault();this.params.attachment=this.params.defaultAttachment;this.setting(this.params.defaultAttachment.url)},removeFile:function(event){if(api.utils.isKeydownButNotEnterEvent(event)){return}event.preventDefault();this.params.attachment={};this.setting('');this.renderContent()}});api.UploadControl=api.MediaControl.extend({select:function(){var node,attachment=this.frame.state().get('selection').first().toJSON(),mejsSettings=window._wpmejsSettings||{};this.params.attachment=attachment;this.setting(attachment.url);node=this.container.find('audio, video').get(0);if(node){this.player=new MediaElementPlayer(node,mejsSettings)}else{this.cleanupPlayer()}},success:function(){},removerVisibility:function(){}});api.ImageControl=api.UploadControl.extend({thumbnailSrc:function(){}});api.BackgroundControl=api.UploadControl.extend({ready:function(){api.UploadControl.prototype.ready.apply(this,arguments)},select:function(){api.UploadControl.prototype.select.apply(this,arguments);wp.ajax.post('custom-background-add',{nonce:_wpCustomizeBackground.nonces.add,wp_customize:'on',customize_theme:api.settings.theme.stylesheet,attachment_id:this.params.attachment.id})}});api.BackgroundPositionControl=api.Control.extend({ready:function(){var control=this,updateRadios;control.container.on('change','input[name="background-position"]',function(){var position=$(this).val().split(' ');control.settings.x(position[0]);control.settings.y(position[1])});updateRadios=_.debounce(function(){var x,y,radioInput,inputValue;x=control.settings.x.get();y=control.settings.y.get();inputValue=String(x)+' '+String(y);radioInput=control.container.find('input[name="background-position"][value="'+inputValue+'"]');radioInput.click()});control.settings.x.bind(updateRadios);control.settings.y.bind(updateRadios);updateRadios()}});api.CroppedImageControl=api.MediaControl.extend({openFrame:function(event){if(api.utils.isKeydownButNotEnterEvent(event)){return}this.initFrame();this.frame.setState('library').open()},initFrame:function(){var l10n=_wpMediaViewsL10n;this.frame=wp.media({button:{text:l10n.select,close:false},states:[new wp.media.controller.Library({title:this.params.button_labels.frame_title,library:wp.media.query({type:'image'}),multiple:false,date:false,priority:20,suggestedWidth:this.params.width,suggestedHeight:this.params.height}),new wp.media.controller.CustomizeImageCropper({imgSelectOptions:this.calculateImageSelectOptions,control:this})]});this.frame.on('select',this.onSelect,this);this.frame.on('cropped',this.onCropped,this);this.frame.on('skippedcrop',this.onSkippedCrop,this)},onSelect:function(){var attachment=this.frame.state().get('selection').first().toJSON();if(this.params.width===attachment.width&&this.params.height===attachment.height&&!this.params.flex_width&&!this.params.flex_height){this.setImageFromAttachment(attachment);this.frame.close()}else{this.frame.setState('cropper')}},onCropped:function(croppedImage){this.setImageFromAttachment(croppedImage)},calculateImageSelectOptions:function(attachment,controller){var control=controller.get('control'),flexWidth=!!parseInt(control.params.flex_width,10),flexHeight=!!parseInt(control.params.flex_height,10),realWidth=attachment.get('width'),realHeight=attachment.get('height'),xInit=parseInt(control.params.width,10),yInit=parseInt(control.params.height,10),ratio=xInit/yInit,xImg=xInit,yImg=yInit,x1,y1,imgSelectOptions;controller.set('canSkipCrop',!control.mustBeCropped(flexWidth,flexHeight,xInit,yInit,realWidth,realHeight));if(realWidth/realHeight>ratio){yInit=realHeight;xInit=yInit*ratio}else{xInit=realWidth;yInit=xInit/ratio}x1=(realWidth-xInit)/2;y1=(realHeight-yInit)/2;imgSelectOptions={handles:true,keys:true,instance:true,persistent:true,imageWidth:realWidth,imageHeight:realHeight,minWidth:xImg>xInit?xInit:xImg,minHeight:yImg>yInit?yInit:yImg,x1:x1,y1:y1,x2:xInit+x1,y2:yInit+y1};if(flexHeight===false&&flexWidth===false){imgSelectOptions.aspectRatio=xInit+':'+yInit}if(true===flexHeight){delete imgSelectOptions.minHeight;imgSelectOptions.maxWidth=realWidth}if(true===flexWidth){delete imgSelectOptions.minWidth;imgSelectOptions.maxHeight=realHeight}return imgSelectOptions},mustBeCropped:function(flexW,flexH,dstW,dstH,imgW,imgH){if(true===flexW&&true===flexH){return false}if(true===flexW&&dstH===imgH){return false}if(true===flexH&&dstW===imgW){return false}if(dstW===imgW&&dstH===imgH){return false}if(imgW<=dstW){return false}return true},onSkippedCrop:function(){var attachment=this.frame.state().get('selection').first().toJSON();this.setImageFromAttachment(attachment)},setImageFromAttachment:function(attachment){this.params.attachment=attachment;this.setting(attachment.id)}});api.SiteIconControl=api.CroppedImageControl.extend({initFrame:function(){var l10n=_wpMediaViewsL10n;this.frame=wp.media({button:{text:l10n.select,close:false},states:[new wp.media.controller.Library({title:this.params.button_labels.frame_title,library:wp.media.query({type:'image'}),multiple:false,date:false,priority:20,suggestedWidth:this.params.width,suggestedHeight:this.params.height}),new wp.media.controller.SiteIconCropper({imgSelectOptions:this.calculateImageSelectOptions,control:this})]});this.frame.on('select',this.onSelect,this);this.frame.on('cropped',this.onCropped,this);this.frame.on('skippedcrop',this.onSkippedCrop,this)},onSelect:function(){var attachment=this.frame.state().get('selection').first().toJSON(),controller=this;if(this.params.width===attachment.width&&this.params.height===attachment.height&&!this.params.flex_width&&!this.params.flex_height){wp.ajax.post('crop-image',{nonce:attachment.nonces.edit,id:attachment.id,context:'site-icon',cropDetails:{x1:0,y1:0,width:this.params.width,height:this.params.height,dst_width:this.params.width,dst_height:this.params.height}}).done(function(croppedImage){controller.setImageFromAttachment(croppedImage);controller.frame.close()}).fail(function(){controller.frame.trigger('content:error:crop')})}else{this.frame.setState('cropper')}},setImageFromAttachment:function(attachment){var sizes=['site_icon-32','thumbnail','full'],link,icon;_.each(sizes,function(size){if(!icon&&!_.isUndefined(attachment.sizes)&&!_.isUndefined(attachment.sizes[size])){icon=attachment.sizes[size]}});this.params.attachment=attachment;this.setting(attachment.id);if(!_.isUndefined(attachment.url)){icon=new Object();icon.url=attachment.url+'/150';icon.id=attachment.id}if(!icon){return}link=$('link[rel="icon"][sizes="32x32"]');link.attr('href',icon.url)},removeFile:function(event){if(api.utils.isKeydownButNotEnterEvent(event)){return}event.preventDefault();this.params.attachment={};this.setting('');this.renderContent();$('link[rel="icon"][sizes="32x32"]').attr('href','/favicon.ico')}});api.HeaderControl=api.Control.extend({ready:function(){this.btnRemove=$('#customize-control-header_image .actions .remove');this.btnNew=$('#customize-control-header_image .actions .new');_.bindAll(this,'openMedia','removeImage');this.btnNew.on('click',this.openMedia);this.btnRemove.on('click',this.removeImage);api.HeaderTool.currentHeader=this.getInitialHeaderImage();new api.HeaderTool.CurrentView({model:api.HeaderTool.currentHeader,el:'#customize-control-header_image .current .container'});new api.HeaderTool.ChoiceListView({collection:api.HeaderTool.UploadsList=new api.HeaderTool.ChoiceList(),el:'#customize-control-header_image .choices .uploaded .list'});new api.HeaderTool.ChoiceListView({collection:api.HeaderTool.DefaultsList=new api.HeaderTool.DefaultsList(),el:'#customize-control-header_image .choices .default .list'});api.HeaderTool.combinedList=api.HeaderTool.CombinedList=new api.HeaderTool.CombinedList([api.HeaderTool.UploadsList,api.HeaderTool.DefaultsList]);wp.media.controller.Cropper.prototype.defaults.doCropArgs.wp_customize='on';wp.media.controller.Cropper.prototype.defaults.doCropArgs.customize_theme=api.settings.theme.stylesheet},getInitialHeaderImage:function(){if(!api.get().header_image||!api.get().header_image_data||_.contains(['remove-header','random-default-image','random-uploaded-image'],api.get().header_image)){return new api.HeaderTool.ImageModel()}var currentHeaderObject=_.find(_wpCustomizeHeader.uploads,function(imageObj){return(imageObj.attachment_id===api.get().header_image_data.attachment_id)});if(!currentHeaderObject){currentHeaderObject={url:api.get().header_image,thumbnail_url:api.get().header_image,attachment_id:api.get().header_image_data.attachment_id}}return new api.HeaderTool.ImageModel({header:currentHeaderObject,choice:currentHeaderObject.url.split('/').pop()})},calculateImageSelectOptions:function(attachment,controller){var xInit=parseInt(_wpCustomizeHeader.data.width,10),yInit=parseInt(_wpCustomizeHeader.data.height,10),flexWidth=!!parseInt(_wpCustomizeHeader.data['flex-width'],10),flexHeight=!!parseInt(_wpCustomizeHeader.data['flex-height'],10),ratio,xImg,yImg,realHeight,realWidth,imgSelectOptions;realWidth=attachment.get('width');realHeight=attachment.get('height');this.headerImage=new api.HeaderTool.ImageModel();this.headerImage.set({themeWidth:xInit,themeHeight:yInit,themeFlexWidth:flexWidth,themeFlexHeight:flexHeight,imageWidth:realWidth,imageHeight:realHeight});controller.set('canSkipCrop',!this.headerImage.shouldBeCropped());ratio=xInit/yInit;xImg=realWidth;yImg=realHeight;if(xImg/yImg>ratio){yInit=yImg;xInit=yInit*ratio}else{xInit=xImg;yInit=xInit/ratio}imgSelectOptions={handles:true,keys:true,instance:true,persistent:true,imageWidth:realWidth,imageHeight:realHeight,x1:0,y1:0,x2:xInit,y2:yInit};if(flexHeight===false&&flexWidth===false){imgSelectOptions.aspectRatio=xInit+':'+yInit}if(flexHeight===false){imgSelectOptions.maxHeight=yInit}if(flexWidth===false){imgSelectOptions.maxWidth=xInit}return imgSelectOptions},openMedia:function(event){var l10n=_wpMediaViewsL10n;event.preventDefault();this.frame=wp.media({button:{text:l10n.selectAndCrop,close:false},states:[new wp.media.controller.Library({title:l10n.chooseImage,library:wp.media.query({type:'image'}),multiple:false,date:false,priority:20,suggestedWidth:_wpCustomizeHeader.data.width,suggestedHeight:_wpCustomizeHeader.data.height}),new wp.media.controller.Cropper({imgSelectOptions:this.calculateImageSelectOptions})]});this.frame.on('select',this.onSelect,this);this.frame.on('cropped',this.onCropped,this);this.frame.on('skippedcrop',this.onSkippedCrop,this);this.frame.open()},onSelect:function(){this.frame.setState('cropper')},onCropped:function(croppedImage){var url=croppedImage.url,attachmentId=croppedImage.attachment_id,w=croppedImage.width,h=croppedImage.height;this.setImageFromURL(url,attachmentId,w,h)},onSkippedCrop:function(selection){var url=selection.get('url'),w=selection.get('width'),h=selection.get('height');this.setImageFromURL(url,selection.id,w,h)},setImageFromURL:function(url,attachmentId,width,height){var choice,data={};data.url=url;data.thumbnail_url=url;data.timestamp=_.now();if(attachmentId){data.attachment_id=attachmentId}if(width){data.width=width}if(height){data.height=height}choice=new api.HeaderTool.ImageModel({header:data,choice:url.split('/').pop()});api.HeaderTool.UploadsList.add(choice);api.HeaderTool.currentHeader.set(choice.toJSON());choice.save();choice.importImage()},removeImage:function(){api.HeaderTool.currentHeader.trigger('hide');api.HeaderTool.CombinedList.trigger('control:removeImage')}});api.ThemeControl=api.Control.extend({touchDrag:false,screenshotRendered:false,ready:function(){var control=this,panel=api.panel('themes');function disableSwitchButtons(){return!panel.canSwitchTheme(control.params.theme.id)}function disableInstallButtons(){return disableSwitchButtons()||false===api.settings.theme._canInstall||true===api.settings.theme._filesystemCredentialsNeeded}function updateButtons(){control.container.find('button.preview, button.preview-theme').toggleClass('disabled',disableSwitchButtons());control.container.find('button.theme-install').toggleClass('disabled',disableInstallButtons())}api.state('selectedChangesetStatus').bind(updateButtons);api.state('changesetStatus').bind(updateButtons);updateButtons();control.container.on('touchmove','.theme',function(){control.touchDrag=true});control.container.on('click keydown touchend','.theme',function(event){var section;if(api.utils.isKeydownButNotEnterEvent(event)){return}if(control.touchDrag===true){return control.touchDrag=false}if($(event.target).is('.theme-actions .button, .update-theme')){return}event.preventDefault();section=api.section(control.section());section.showDetails(control.params.theme,function(){if(api.settings.theme._filesystemCredentialsNeeded){section.overlay.find('.theme-actions .delete-theme').remove()}})});control.container.on('render-screenshot',function(){var $screenshot=$(this).find('img'),source=$screenshot.data('src');if(source){$screenshot.attr('src',source)}control.screenshotRendered=true})},filter:function(terms){var control=this,matchCount=0,haystack=control.params.theme.name+' '+control.params.theme.description+' '+control.params.theme.tags+' '+control.params.theme.author+' ';haystack=haystack.toLowerCase().replace('-',' ');if(!_.isArray(terms)){terms=[terms]}if(control.params.theme.name.toLowerCase()===terms.join(' ')){matchCount=100}else{matchCount=matchCount+10*(haystack.split(terms.join(' ')).length-1);_.each(terms,function(term){matchCount=matchCount+2*(haystack.split(term+' ').length-1);matchCount=matchCount+haystack.split(term).length-1});if(matchCount>99){matchCount=99}}if(0!==matchCount){control.activate();control.params.priority=101-matchCount;return true}else{control.deactivate();control.params.priority=101;return false}},rerenderAsInstalled:function(installed){var control=this,section;if(installed){control.params.theme.type='installed'}else{section=api.section(control.params.section);control.params.theme.type=section.params.action}control.renderContent();control.container.trigger('render-screenshot')}});api.CodeEditorControl=api.Control.extend({initialize:function(id,options){var control=this;control.deferred=_.extend(control.deferred||{},{codemirror:$.Deferred()});api.Control.prototype.initialize.call(control,id,options);control.notifications.bind('add',function(notification){if(notification.code!==control.setting.id+':csslint_error'){return}notification.templateId='customize-code-editor-lint-error-notification';notification.render=(function(render){return function(){var li=render.call(this);li.find('input[type=checkbox]').on('click',function(){control.setting.notifications.remove('csslint_error')});return li}})(notification.render)})},ready:function(){var control=this;if(!control.section()){control.initEditor();return}api.section(control.section(),function(section){section.deferred.embedded.done(function(){var onceExpanded;if(section.expanded()){control.initEditor()}else{onceExpanded=function(isExpanded){if(isExpanded){control.initEditor();section.expanded.unbind(onceExpanded)}};section.expanded.bind(onceExpanded)}})})},initEditor:function(){var control=this,element,editorSettings=false;if(wp.codeEditor&&(_.isUndefined(control.params.editor_settings)||false!==control.params.editor_settings)){editorSettings=wp.codeEditor.defaultSettings?_.clone(wp.codeEditor.defaultSettings):{};editorSettings.codemirror=_.extend({},editorSettings.codemirror,{indentUnit:2,tabSize:2});if(_.isObject(control.params.editor_settings)){_.each(control.params.editor_settings,function(value,key){if(_.isObject(value)){editorSettings[key]=_.extend({},editorSettings[key],value)}})}}element=new api.Element(control.container.find('textarea'));control.elements.push(element);element.sync(control.setting);element.set(control.setting());if(editorSettings){control.initSyntaxHighlightingEditor(editorSettings)}else{control.initPlainTextareaEditor()}},focus:function(params){var control=this,extendedParams=_.extend({},params),originalCompleteCallback;originalCompleteCallback=extendedParams.completeCallback;extendedParams.completeCallback=function(){if(originalCompleteCallback){originalCompleteCallback()}if(control.editor){control.editor.codemirror.focus()}};api.Control.prototype.focus.call(control,extendedParams)},initSyntaxHighlightingEditor:function(codeEditorSettings){var control=this,$textarea=control.container.find('textarea'),settings,suspendEditorUpdate=false;settings=_.extend({},codeEditorSettings,{onTabNext:_.bind(control.onTabNext,control),onTabPrevious:_.bind(control.onTabPrevious,control),onUpdateErrorNotice:_.bind(control.onUpdateErrorNotice,control)});control.editor=wp.codeEditor.initialize($textarea,settings);$(control.editor.codemirror.display.lineDiv).attr({role:'textbox','aria-multiline':'true','aria-label':control.params.label,'aria-describedby':'editor-keyboard-trap-help-1 editor-keyboard-trap-help-2 editor-keyboard-trap-help-3 editor-keyboard-trap-help-4'});control.container.find('label').on('click',function(){control.editor.codemirror.focus()});control.editor.codemirror.on('change',function(codemirror){suspendEditorUpdate=true;$textarea.val(codemirror.getValue()).trigger('change');suspendEditorUpdate=false});control.setting.bind(function(value){if(!suspendEditorUpdate){control.editor.codemirror.setValue(value)}});control.editor.codemirror.on('keydown',function onKeydown(codemirror,event){var escKeyCode=27;if(escKeyCode===event.keyCode){event.stopPropagation()}});control.deferred.codemirror.resolveWith(control,[control.editor.codemirror])},onTabNext:function onTabNext(){var control=this,controls,controlIndex,section;section=api.section(control.section());controls=section.controls();controlIndex=controls.indexOf(control);if(controls.length===controlIndex+1){$('#customize-footer-actions .collapse-sidebar').focus()}else{controls[controlIndex+1].container.find(':focusable:first').focus()}},onTabPrevious:function onTabPrevious(){var control=this,controls,controlIndex,section;section=api.section(control.section());controls=section.controls();controlIndex=controls.indexOf(control);if(0===controlIndex){section.contentContainer.find('.customize-section-title .customize-help-toggle, .customize-section-title .customize-section-description.open .section-description-close').last().focus()}else{controls[controlIndex-1].contentContainer.find(':focusable:first').focus()}},onUpdateErrorNotice:function onUpdateErrorNotice(errorAnnotations){var control=this,message;control.setting.notifications.remove('csslint_error');if(0!==errorAnnotations.length){if(1===errorAnnotations.length){message=api.l10n.customCssError.singular.replace('%d','1')}else{message=api.l10n.customCssError.plural.replace('%d',String(errorAnnotations.length))}control.setting.notifications.add(new api.Notification('csslint_error',{message:message,type:'error'}))}},initPlainTextareaEditor:function(){var control=this,$textarea=control.container.find('textarea'),textarea=$textarea[0];$textarea.on('blur',function onBlur(){$textarea.data('next-tab-blurs',false)});$textarea.on('keydown',function onKeydown(event){var selectionStart,selectionEnd,value,tabKeyCode=9,escKeyCode=27;if(escKeyCode===event.keyCode){if(!$textarea.data('next-tab-blurs')){$textarea.data('next-tab-blurs',true);event.stopPropagation()}return}if(tabKeyCode!==event.keyCode||event.ctrlKey||event.altKey||event.shiftKey){return}if($textarea.data('next-tab-blurs')){return}selectionStart=textarea.selectionStart;selectionEnd=textarea.selectionEnd;value=textarea.value;if(selectionStart>=0){textarea.value=value.substring(0,selectionStart).concat('\t',value.substring(selectionEnd));$textarea.selectionStart=textarea.selectionEnd=selectionStart+1}event.stopPropagation();event.preventDefault()});control.deferred.codemirror.rejectWith(control)}});api.DateTimeControl=api.Control.extend({ready:function ready(){var control=this;control.inputElements={};control.invalidDate=false;_.bindAll(control,'populateSetting','updateDaysForMonth','populateDateInputs');if(!control.setting){throw new Error('Missing setting');}control.container.find('.date-input').each(function(){var input=$(this),component,element;component=input.data('component');element=new api.Element(input);control.inputElements[component]=element;control.elements.push(element);input.on('change',function(){if(control.invalidDate){control.notifications.add(new api.Notification('invalid_date',{message:api.l10n.invalidDate}))}});input.on('input',_.debounce(function(){if(!control.invalidDate){control.notifications.remove('invalid_date')}}));input.on('blur',_.debounce(function(){if(!control.invalidDate){control.populateDateInputs()}}))});control.inputElements.month.bind(control.updateDaysForMonth);control.inputElements.year.bind(control.updateDaysForMonth);control.populateDateInputs();control.setting.bind(control.populateDateInputs);_.each(control.inputElements,function(element){element.bind(control.populateSetting)})},parseDateTime:function parseDateTime(datetime){var control=this,matches,date,midDayHour=12;if(datetime){matches=datetime.match(/^(\d\d\d\d)-(\d\d)-(\d\d)(?: (\d\d):(\d\d)(?::(\d\d))?)?$/)}if(!matches){return null}matches.shift();date={year:matches.shift(),month:matches.shift(),day:matches.shift(),hour:matches.shift()||'00',minute:matches.shift()||'00',second:matches.shift()||'00'};if(control.params.includeTime&&control.params.twelveHourFormat){date.hour=parseInt(date.hour,10);date.meridian=date.hour>=midDayHour?'pm':'am';date.hour=date.hour%midDayHour?String(date.hour%midDayHour):String(midDayHour);delete date.second}return date},validateInputs:function validateInputs(){var control=this,components,validityInput;control.invalidDate=false;components=['year','day'];if(control.params.includeTime){components.push('hour','minute')}_.find(components,function(component){var element,max,min,value;element=control.inputElements[component];validityInput=element.element.get(0);max=parseInt(element.element.attr('max'),10);min=parseInt(element.element.attr('min'),10);value=parseInt(element(),10);control.invalidDate=isNaN(value)||value>max||value<min;if(!control.invalidDate){validityInput.setCustomValidity('')}return control.invalidDate});if(control.inputElements.meridian&&!control.invalidDate){validityInput=control.inputElements.meridian.element.get(0);if('am'!==control.inputElements.meridian.get()&&'pm'!==control.inputElements.meridian.get()){control.invalidDate=true}else{validityInput.setCustomValidity('')}}if(control.invalidDate){validityInput.setCustomValidity(api.l10n.invalidValue)}else{validityInput.setCustomValidity('')}if(!control.section()||api.section.has(control.section())&&api.section(control.section()).expanded()){_.result(validityInput,'reportValidity')}return control.invalidDate},updateDaysForMonth:function updateDaysForMonth(){var control=this,daysInMonth,year,month,day;month=parseInt(control.inputElements.month(),10);year=parseInt(control.inputElements.year(),10);day=parseInt(control.inputElements.day(),10);if(month&&year){daysInMonth=new Date(year,month,0).getDate();control.inputElements.day.element.attr('max',daysInMonth);if(day>daysInMonth){control.inputElements.day(String(daysInMonth))}}},populateSetting:function populateSetting(){var control=this,date;if(control.validateInputs()||!control.params.allowPastDate&&!control.isFutureDate()){return false}date=control.convertInputDateToString();control.setting.set(date);return true},convertInputDateToString:function convertInputDateToString(){var control=this,date='',dateFormat,hourInTwentyFourHourFormat,getElementValue,pad;pad=function(number,padding){var zeros;if(String(number).length<padding){zeros=padding-String(number).length;number=Math.pow(10,zeros).toString().substr(1)+String(number)}return number};getElementValue=function(component){var value=parseInt(control.inputElements[component].get(),10);if(_.contains(['month','day','hour','minute'],component)){value=pad(value,2)}else if('year'===component){value=pad(value,4)}return value};dateFormat=['year','-','month','-','day'];if(control.params.includeTime){hourInTwentyFourHourFormat=control.inputElements.meridian?control.convertHourToTwentyFourHourFormat(control.inputElements.hour(),control.inputElements.meridian()):control.inputElements.hour();dateFormat=dateFormat.concat([' ',pad(hourInTwentyFourHourFormat,2),':','minute',':','00'])}_.each(dateFormat,function(component){date+=control.inputElements[component]?getElementValue(component):component});return date},isFutureDate:function isFutureDate(){var control=this;return 0<api.utils.getRemainingTime(control.convertInputDateToString())},convertHourToTwentyFourHourFormat:function convertHour(hourInTwelveHourFormat,meridian){var hourInTwentyFourHourFormat,hour,midDayHour=12;hour=parseInt(hourInTwelveHourFormat,10);if(isNaN(hour)){return''}if('pm'===meridian&&hour<midDayHour){hourInTwentyFourHourFormat=hour+midDayHour}else if('am'===meridian&&midDayHour===hour){hourInTwentyFourHourFormat=hour-midDayHour}else{hourInTwentyFourHourFormat=hour}return String(hourInTwentyFourHourFormat)},populateDateInputs:function populateDateInputs(){var control=this,parsed;parsed=control.parseDateTime(control.setting.get());if(!parsed){return false}_.each(control.inputElements,function(element,component){var value=parsed[component];if('month'===component||'meridian'===component){value=value.replace(/^0/,'');element.set(value)}else{value=parseInt(value,10);if(!element.element.is(document.activeElement)){element.set(parsed[component])}else if(value!==parseInt(element(),10)){element.set(String(value))}}});return true},toggleFutureDateNotification:function toggleFutureDateNotification(notify){var control=this,notificationCode,notification;notificationCode='not_future_date';if(notify){notification=new api.Notification(notificationCode,{type:'error',message:api.l10n.futureDateError});control.notifications.add(notification)}else{control.notifications.remove(notificationCode)}return control}});api.PreviewLinkControl=api.Control.extend({defaults:_.extend({},api.Control.prototype.defaults,{templateId:'customize-preview-link-control'}),ready:function ready(){var control=this,element,component,node,url,input,button;_.bindAll(control,'updatePreviewLink');if(!control.setting){control.setting=new api.Value()}control.previewElements={};control.container.find('.preview-control-element').each(function(){node=$(this);component=node.data('component');element=new api.Element(node);control.previewElements[component]=element;control.elements.push(element)});url=control.previewElements.url;input=control.previewElements.input;button=control.previewElements.button;input.link(control.setting);url.link(control.setting);url.bind(function(value){url.element.parent().attr({href:value,target:api.settings.changeset.uuid})});api.bind('ready',control.updatePreviewLink);api.state('saved').bind(control.updatePreviewLink);api.state('changesetStatus').bind(control.updatePreviewLink);api.state('activated').bind(control.updatePreviewLink);api.previewer.previewUrl.bind(control.updatePreviewLink);button.element.on('click',function(event){event.preventDefault();if(control.setting()){input.element.select();document.execCommand('copy');button(button.element.data('copied-text'))}});url.element.parent().on('click',function(event){if($(this).hasClass('disabled')){event.preventDefault()}});button.element.on('mouseenter',function(){if(control.setting()){button(button.element.data('copy-text'))}})},updatePreviewLink:function updatePreviewLink(){var control=this,unsavedDirtyValues;unsavedDirtyValues=!api.state('saved').get()||''===api.state('changesetStatus').get()||'auto-draft'===api.state('changesetStatus').get();control.toggleSaveNotification(unsavedDirtyValues);control.previewElements.url.element.parent().toggleClass('disabled',unsavedDirtyValues);control.previewElements.button.element.prop('disabled',unsavedDirtyValues);control.setting.set(api.previewer.getFrontendPreviewUrl())},toggleSaveNotification:function toggleSaveNotification(notify){var control=this,notificationCode,notification;notificationCode='changes_not_saved';if(notify){notification=new api.Notification(notificationCode,{type:'info',message:api.l10n.saveBeforeShare});control.notifications.add(notification)}else{control.notifications.remove(notificationCode)}}});api.defaultConstructor=api.Setting;api.control=new api.Values({defaultConstructor:api.Control});api.section=new api.Values({defaultConstructor:api.Section});api.panel=new api.Values({defaultConstructor:api.Panel});api.notifications=new api.Notifications();api.PreviewFrame=api.Messenger.extend({sensitivity:null,initialize:function(params,options){var deferred=$.Deferred();deferred.promise(this);this.container=params.container;$.extend(params,{channel:api.PreviewFrame.uuid()});api.Messenger.prototype.initialize.call(this,params,options);this.add('previewUrl',params.previewUrl);this.query=$.extend(params.query||{},{customize_messenger_channel:this.channel()});this.run(deferred)},run:function(deferred){var previewFrame=this,loaded=false,ready=false,readyData=null,hasPendingChangesetUpdate='{}'!==previewFrame.query.customized,urlParser,params,form;if(previewFrame._ready){previewFrame.unbind('ready',previewFrame._ready)}previewFrame._ready=function(data){ready=true;readyData=data;previewFrame.container.addClass('iframe-ready');if(!data){return}if(loaded){deferred.resolveWith(previewFrame,[data])}};previewFrame.bind('ready',previewFrame._ready);urlParser=document.createElement('a');urlParser.href=previewFrame.previewUrl();params=_.extend(api.utils.parseQueryString(urlParser.search.substr(1)),{customize_changeset_uuid:previewFrame.query.customize_changeset_uuid,customize_theme:previewFrame.query.customize_theme,customize_messenger_channel:previewFrame.query.customize_messenger_channel});if(api.settings.changeset.autosaved||!api.state('saved').get()){params.customize_autosaved='on'}urlParser.search=$.param(params);previewFrame.iframe=$('<iframe />',{title:api.l10n.previewIframeTitle,name:'customize-'+previewFrame.channel()});previewFrame.iframe.attr('onmousewheel','');if(!hasPendingChangesetUpdate){previewFrame.iframe.attr('src',urlParser.href)}else{previewFrame.iframe.attr('data-src',urlParser.href)}previewFrame.iframe.appendTo(previewFrame.container);previewFrame.targetWindow(previewFrame.iframe[0].contentWindow);if(hasPendingChangesetUpdate){form=$('<form>',{action:urlParser.href,target:previewFrame.iframe.attr('name'),method:'post',hidden:'hidden'});form.append($('<input>',{type:'hidden',name:'_method',value:'GET'}));_.each(previewFrame.query,function(value,key){form.append($('<input>',{type:'hidden',name:key,value:value}))});previewFrame.container.append(form);form.submit();form.remove()}previewFrame.bind('iframe-loading-error',function(error){previewFrame.iframe.remove();if(0===error){previewFrame.login(deferred);return}if(-1===error){deferred.rejectWith(previewFrame,['cheatin']);return}deferred.rejectWith(previewFrame,['request failure'])});previewFrame.iframe.one('load',function(){loaded=true;if(ready){deferred.resolveWith(previewFrame,[readyData])}else{setTimeout(function(){deferred.rejectWith(previewFrame,['ready timeout'])},previewFrame.sensitivity)}})},login:function(deferred){var self=this,reject;reject=function(){deferred.rejectWith(self,['logged out'])};if(this.triedLogin){return reject()}$.get(api.settings.url.ajax,{action:'logged-in'}).fail(reject).done(function(response){var iframe;if('1'!==response){reject()}iframe=$('<iframe />',{'src':self.previewUrl(),'title':api.l10n.previewIframeTitle}).hide();iframe.appendTo(self.container);iframe.on('load',function(){self.triedLogin=true;iframe.remove();self.run(deferred)})})},destroy:function(){api.Messenger.prototype.destroy.call(this);if(this.iframe){this.iframe.remove()}delete this.iframe;delete this.targetWindow}});(function(){var id=0;api.PreviewFrame.uuid=function(){return'preview-'+String(id++)}}());api.setDocumentTitle=function(documentTitle){var tmpl,title;tmpl=api.settings.documentTitleTmpl;title=tmpl.replace('%s',documentTitle);document.title=title;api.trigger('title',title)};api.Previewer=api.Messenger.extend({refreshBuffer:null,initialize:function(params,options){var previewer=this,urlParser=document.createElement('a');$.extend(previewer,options||{});previewer.deferred={active:$.Deferred()};previewer.refresh=_.debounce((function(originalRefresh){return function(){var isProcessingComplete,refreshOnceProcessingComplete;isProcessingComplete=function(){return 0===api.state('processing').get()};if(isProcessingComplete()){originalRefresh.call(previewer)}else{refreshOnceProcessingComplete=function(){if(isProcessingComplete()){originalRefresh.call(previewer);api.state('processing').unbind(refreshOnceProcessingComplete)}};api.state('processing').bind(refreshOnceProcessingComplete)}}}(previewer.refresh)),previewer.refreshBuffer);previewer.container=api.ensure(params.container);previewer.allowedUrls=params.allowedUrls;params.url=window.location.href;api.Messenger.prototype.initialize.call(previewer,params);urlParser.href=previewer.origin();previewer.add('scheme',urlParser.protocol.replace(/:$/,''));previewer.add('previewUrl',params.previewUrl).setter(function(to){var result=null,urlParser,queryParams,parsedAllowedUrl,parsedCandidateUrls=[];urlParser=document.createElement('a');urlParser.href=to;if(/\/wp-(admin|includes|content)(\/|$)/.test(urlParser.pathname)){return null}if(urlParser.search.length>1){queryParams=api.utils.parseQueryString(urlParser.search.substr(1));delete queryParams.customize_changeset_uuid;delete queryParams.customize_theme;delete queryParams.customize_messenger_channel;delete queryParams.customize_autosaved;if(_.isEmpty(queryParams)){urlParser.search=''}else{urlParser.search=$.param(queryParams)}}parsedCandidateUrls.push(urlParser);if(previewer.scheme.get()+':'!==urlParser.protocol){urlParser=document.createElement('a');urlParser.href=parsedCandidateUrls[0].href;urlParser.protocol=previewer.scheme.get()+':';parsedCandidateUrls.unshift(urlParser)}parsedAllowedUrl=document.createElement('a');_.find(parsedCandidateUrls,function(parsedCandidateUrl){return!_.isUndefined(_.find(previewer.allowedUrls,function(allowedUrl){parsedAllowedUrl.href=allowedUrl;if(urlParser.protocol===parsedAllowedUrl.protocol&&urlParser.host===parsedAllowedUrl.host&&0===urlParser.pathname.indexOf(parsedAllowedUrl.pathname.replace(/\/$/,''))){result=parsedCandidateUrl.href;return true}}))});return result});previewer.bind('ready',previewer.ready);previewer.deferred.active.done(_.bind(previewer.keepPreviewAlive,previewer));previewer.bind('synced',function(){previewer.send('active')});previewer.previewUrl.bind(previewer.refresh);previewer.scroll=0;previewer.bind('scroll',function(distance){previewer.scroll=distance});previewer.bind('url',function(url){var onUrlChange,urlChanged=false;previewer.scroll=0;onUrlChange=function(){urlChanged=true};previewer.previewUrl.bind(onUrlChange);previewer.previewUrl.set(url);previewer.previewUrl.unbind(onUrlChange);if(!urlChanged){previewer.refresh()}});previewer.bind('documentTitle',function(title){api.setDocumentTitle(title)})},ready:function(data){var previewer=this,synced={},constructs;synced.settings=api.get();synced['settings-modified-while-loading']=previewer.settingsModifiedWhileLoading;if('resolved'!==previewer.deferred.active.state()||previewer.loading){synced.scroll=previewer.scroll}synced['edit-shortcut-visibility']=api.state('editShortcutVisibility').get();previewer.send('sync',synced);if(data.currentUrl){previewer.previewUrl.unbind(previewer.refresh);previewer.previewUrl.set(data.currentUrl);previewer.previewUrl.bind(previewer.refresh)}constructs={panel:data.activePanels,section:data.activeSections,control:data.activeControls};_(constructs).each(function(activeConstructs,type){api[type].each(function(construct,id){var isDynamicallyCreated=_.isUndefined(api.settings[type+'s'][id]);if(!isDynamicallyCreated||!_.isUndefined(activeConstructs[id])){if(activeConstructs[id]){construct.activate()}else{construct.deactivate()}}})});if(data.settingValidities){api._handleSettingValidities({settingValidities:data.settingValidities,focusInvalidControl:false})}},keepPreviewAlive:function keepPreviewAlive(){var previewer=this,keepAliveTick,timeoutId,handleMissingKeepAlive,scheduleKeepAliveCheck;scheduleKeepAliveCheck=function(){timeoutId=setTimeout(handleMissingKeepAlive,api.settings.timeouts.keepAliveCheck)};keepAliveTick=function(){api.state('previewerAlive').set(true);clearTimeout(timeoutId);scheduleKeepAliveCheck()};handleMissingKeepAlive=function(){api.state('previewerAlive').set(false)};scheduleKeepAliveCheck();previewer.bind('ready',keepAliveTick);previewer.bind('keep-alive',keepAliveTick)},query:function(){},abort:function(){if(this.loading){this.loading.destroy();delete this.loading}},refresh:function(){var previewer=this,onSettingChange;previewer.send('loading-initiated');previewer.abort();previewer.loading=new api.PreviewFrame({url:previewer.url(),previewUrl:previewer.previewUrl(),query:previewer.query({excludeCustomizedSaved:true})||{},container:previewer.container});previewer.settingsModifiedWhileLoading={};onSettingChange=function(setting){previewer.settingsModifiedWhileLoading[setting.id]=true};api.bind('change',onSettingChange);previewer.loading.always(function(){api.unbind('change',onSettingChange)});previewer.loading.done(function(readyData){var loadingFrame=this,onceSynced;previewer.preview=loadingFrame;previewer.targetWindow(loadingFrame.targetWindow());previewer.channel(loadingFrame.channel());onceSynced=function(){loadingFrame.unbind('synced',onceSynced);if(previewer._previousPreview){previewer._previousPreview.destroy()}previewer._previousPreview=previewer.preview;previewer.deferred.active.resolve();delete previewer.loading};loadingFrame.bind('synced',onceSynced);previewer.trigger('ready',readyData)});previewer.loading.fail(function(reason){previewer.send('loading-failed');if('logged out'===reason){if(previewer.preview){previewer.preview.destroy();delete previewer.preview}previewer.login().done(previewer.refresh)}if('cheatin'===reason){previewer.cheatin()}})},login:function(){var previewer=this,deferred,messenger,iframe;if(this._login){return this._login}deferred=$.Deferred();this._login=deferred.promise();messenger=new api.Messenger({channel:'login',url:api.settings.url.login});iframe=$('<iframe />',{'src':api.settings.url.login,'title':api.l10n.loginIframeTitle}).appendTo(this.container);messenger.targetWindow(iframe[0].contentWindow);messenger.bind('login',function(){var refreshNonces=previewer.refreshNonces();refreshNonces.always(function(){iframe.remove();messenger.destroy();delete previewer._login});refreshNonces.done(function(){deferred.resolve()});refreshNonces.fail(function(){previewer.cheatin();deferred.reject()})});return this._login},cheatin:function(){$(document.body).empty().addClass('cheatin').append('<h1>'+api.l10n.notAllowedHeading+'</h1>'+'<p>'+api.l10n.notAllowed+'</p>')},refreshNonces:function(){var request,deferred=$.Deferred();deferred.promise();request=wp.ajax.post('customize_refresh_nonces',{wp_customize:'on',customize_theme:api.settings.theme.stylesheet});request.done(function(response){api.trigger('nonce-refresh',response);deferred.resolve()});request.fail(function(){deferred.reject()});return deferred}});api.settingConstructor={};api.controlConstructor={color:api.ColorControl,media:api.MediaControl,upload:api.UploadControl,image:api.ImageControl,cropped_image:api.CroppedImageControl,site_icon:api.SiteIconControl,header:api.HeaderControl,background:api.BackgroundControl,background_position:api.BackgroundPositionControl,theme:api.ThemeControl,date_time:api.DateTimeControl,code_editor:api.CodeEditorControl};api.panelConstructor={themes:api.ThemesPanel};api.sectionConstructor={themes:api.ThemesSection,outer:api.OuterSection};api._handleSettingValidities=function handleSettingValidities(args){var invalidSettingControls,invalidSettings=[],wasFocused=false;_.each(args.settingValidities,function(validity,settingId){var setting=api(settingId);if(setting){if(_.isObject(validity)){_.each(validity,function(params,code){var notification,existingNotification,needsReplacement=false;notification=new api.Notification(code,_.extend({fromServer:true},params));existingNotification=setting.notifications(notification.code);if(existingNotification){needsReplacement=notification.type!==existingNotification.type||notification.message!==existingNotification.message||!_.isEqual(notification.data,existingNotification.data)}if(needsReplacement){setting.notifications.remove(code)}if(!setting.notifications.has(notification.code)){setting.notifications.add(notification)}invalidSettings.push(setting.id)})}setting.notifications.each(function(notification){if(notification.fromServer&&'error'===notification.type&&(true===validity||!validity[notification.code])){setting.notifications.remove(notification.code)}})}});if(args.focusInvalidControl){invalidSettingControls=api.findControlsForSettings(invalidSettings);_(_.values(invalidSettingControls)).find(function(controls){return _(controls).find(function(control){var isExpanded=control.section()&&api.section.has(control.section())&&api.section(control.section()).expanded();if(isExpanded&&control.expanded){isExpanded=control.expanded()}if(isExpanded){control.focus();wasFocused=true}return wasFocused})});if(!wasFocused&&!_.isEmpty(invalidSettingControls)){_.values(invalidSettingControls)[0][0].focus()}}};api.findControlsForSettings=function findControlsForSettings(settingIds){var controls={},settingControls;_.each(_.unique(settingIds),function(settingId){var setting=api(settingId);if(setting){settingControls=setting.findControls();if(settingControls&&settingControls.length>0){controls[settingId]=settingControls}}});return controls};api.reflowPaneContents=_.bind(function(){var appendContainer,activeElement,rootHeadContainers,rootNodes=[],wasReflowed=false;if(document.activeElement){activeElement=$(document.activeElement)}api.panel.each(function(panel){if('themes'===panel.id){return}var sections=panel.sections(),sectionHeadContainers=_.pluck(sections,'headContainer');rootNodes.push(panel);appendContainer=(panel.contentContainer.is('ul'))?panel.contentContainer:panel.contentContainer.find('ul:first');if(!api.utils.areElementListsEqual(sectionHeadContainers,appendContainer.children('[id]'))){_(sections).each(function(section){appendContainer.append(section.headContainer)});wasReflowed=true}});api.section.each(function(section){var controls=section.controls(),controlContainers=_.pluck(controls,'container');if(!section.panel()){rootNodes.push(section)}appendContainer=(section.contentContainer.is('ul'))?section.contentContainer:section.contentContainer.find('ul:first');if(!api.utils.areElementListsEqual(controlContainers,appendContainer.children('[id]'))){_(controls).each(function(control){appendContainer.append(control.container)});wasReflowed=true}});rootNodes.sort(api.utils.prioritySort);rootHeadContainers=_.pluck(rootNodes,'headContainer');appendContainer=$('#customize-theme-controls .customize-pane-parent');if(!api.utils.areElementListsEqual(rootHeadContainers,appendContainer.children())){_(rootNodes).each(function(rootNode){appendContainer.append(rootNode.headContainer)});wasReflowed=true}api.panel.each(function(panel){var value=panel.active();panel.active.callbacks.fireWith(panel.active,[value,value])});api.section.each(function(section){var value=section.active();section.active.callbacks.fireWith(section.active,[value,value])});if(wasReflowed&&activeElement){activeElement.focus()}api.trigger('pane-contents-reflowed')},api);api.state=new api.Values();_.each(['saved','saving','trashing','activated','processing','paneVisible','expandedPanel','expandedSection','changesetDate','selectedChangesetDate','changesetStatus','selectedChangesetStatus','remainingTimeToPublish','previewerAlive','editShortcutVisibility','changesetLocked','previewedDevice'],function(name){api.state.create(name)});$(function(){api.settings=window._wpCustomizeSettings;api.l10n=window._wpCustomizeControlsL10n;if(!api.settings){return}if(!$.support.postMessage||(!$.support.cors&&api.settings.isCrossDomain)){return}if(null===api.PreviewFrame.prototype.sensitivity){api.PreviewFrame.prototype.sensitivity=api.settings.timeouts.previewFrameSensitivity}if(null===api.Previewer.prototype.refreshBuffer){api.Previewer.prototype.refreshBuffer=api.settings.timeouts.windowRefresh}var parent,body=$(document.body),overlay=body.children('.wp-full-overlay'),title=$('#customize-info .panel-title.site-title'),closeBtn=$('.customize-controls-close'),saveBtn=$('#save'),btnWrapper=$('#customize-save-button-wrapper'),publishSettingsBtn=$('#publish-settings'),footerActions=$('#customize-footer-actions');api.bind('ready',function(){api.section.add(new api.OuterSection('publish_settings',{title:api.l10n.publishSettings,priority:0,active:api.settings.theme.active}))});api.section('publish_settings',function(section){var updateButtonsState,trashControl,updateSectionActive,isSectionActive,statusControl,dateControl,toggleDateControl,publishWhenTime,pollInterval,updateTimeArrivedPoller,cancelScheduleButtonReminder,timeArrivedPollingInterval=1000;trashControl=new api.Control('trash_changeset',{type:'button',section:section.id,priority:30,input_attrs:{'class':'button-link button-link-delete',value:api.l10n.discardChanges}});api.control.add(trashControl);trashControl.deferred.embedded.done(function(){trashControl.container.find('.button-link').on('click',function(){if(confirm(api.l10n.trashConfirm)){wp.customize.previewer.trash()}})});api.control.add(new api.PreviewLinkControl('changeset_preview_link',{section:section.id,priority:100}));isSectionActive=function(){if(!api.state('activated').get()){return false}if(api.state('trashing').get()||'trash'===api.state('changesetStatus').get()){return false}if(''===api.state('changesetStatus').get()&&api.state('saved').get()){return false}return true};section.active.validate=isSectionActive;updateSectionActive=function(){section.active.set(isSectionActive())};api.state('activated').bind(updateSectionActive);api.state('trashing').bind(updateSectionActive);api.state('saved').bind(updateSectionActive);api.state('changesetStatus').bind(updateSectionActive);updateSectionActive();updateButtonsState=function(){publishSettingsBtn.toggle(section.active.get());saveBtn.toggleClass('has-next-sibling',section.active.get())};updateButtonsState();section.active.bind(updateButtonsState);function highlightScheduleButton(){if(!cancelScheduleButtonReminder){cancelScheduleButtonReminder=api.utils.highlightButton(btnWrapper,{delay:1000,focusTarget:saveBtn})}}function cancelHighlightScheduleButton(){if(cancelScheduleButtonReminder){cancelScheduleButtonReminder();cancelScheduleButtonReminder=null}}api.state('selectedChangesetStatus').bind(cancelHighlightScheduleButton);section.contentContainer.find('.customize-action').text(api.l10n.updating);section.contentContainer.find('.customize-section-back').removeAttr('tabindex');publishSettingsBtn.prop('disabled',false);publishSettingsBtn.on('click',function(event){event.preventDefault();section.expanded.set(!section.expanded.get())});section.expanded.bind(function(isExpanded){var defaultChangesetStatus;publishSettingsBtn.attr('aria-expanded',String(isExpanded));publishSettingsBtn.toggleClass('active',isExpanded);if(isExpanded){cancelHighlightScheduleButton();return}defaultChangesetStatus=api.state('changesetStatus').get();if(''===defaultChangesetStatus||'auto-draft'===defaultChangesetStatus){defaultChangesetStatus='publish'}if(api.state('selectedChangesetStatus').get()!==defaultChangesetStatus){highlightScheduleButton()}else if('future'===api.state('selectedChangesetStatus').get()&&api.state('selectedChangesetDate').get()!==api.state('changesetDate').get()){highlightScheduleButton()}});statusControl=new api.Control('changeset_status',{priority:10,type:'radio',section:'publish_settings',setting:api.state('selectedChangesetStatus'),templateId:'customize-selected-changeset-status-control',label:api.l10n.action,choices:api.settings.changeset.statusChoices});api.control.add(statusControl);dateControl=new api.DateTimeControl('changeset_scheduled_date',{priority:20,section:'publish_settings',setting:api.state('selectedChangesetDate'),minYear:(new Date()).getFullYear(),allowPastDate:false,includeTime:true,twelveHourFormat:/a/i.test(api.settings.timeFormat),description:api.l10n.scheduleDescription});dateControl.notifications.alt=true;api.control.add(dateControl);publishWhenTime=function(){api.state('selectedChangesetStatus').set('publish');api.previewer.save()};updateTimeArrivedPoller=function(){var shouldPoll=('future'===api.state('changesetStatus').get()&&'future'===api.state('selectedChangesetStatus').get()&&api.state('changesetDate').get()&&api.state('selectedChangesetDate').get()===api.state('changesetDate').get()&&api.utils.getRemainingTime(api.state('changesetDate').get())>=0);if(shouldPoll&&!pollInterval){pollInterval=setInterval(function(){var remainingTime=api.utils.getRemainingTime(api.state('changesetDate').get());api.state('remainingTimeToPublish').set(remainingTime);if(remainingTime<=0){clearInterval(pollInterval);pollInterval=0;publishWhenTime()}},timeArrivedPollingInterval)}else if(!shouldPoll&&pollInterval){clearInterval(pollInterval);pollInterval=0}};api.state('changesetDate').bind(updateTimeArrivedPoller);api.state('selectedChangesetDate').bind(updateTimeArrivedPoller);api.state('changesetStatus').bind(updateTimeArrivedPoller);api.state('selectedChangesetStatus').bind(updateTimeArrivedPoller);updateTimeArrivedPoller();dateControl.active.validate=function(){return'future'===api.state('selectedChangesetStatus').get()};toggleDateControl=function(value){dateControl.active.set('future'===value)};toggleDateControl(api.state('selectedChangesetStatus').get());api.state('selectedChangesetStatus').bind(toggleDateControl);api.state('saving').bind(function(isSaving){if(isSaving&&'future'===api.state('selectedChangesetStatus').get()){dateControl.toggleFutureDateNotification(!dateControl.isFutureDate())}})});$('#customize-controls').on('keydown',function(e){var isEnter=(13===e.which),$el=$(e.target);if(isEnter&&($el.is('input:not([type=button])')||$el.is('select'))){e.preventDefault()}});$('.customize-info').find('> .accordion-section-title .customize-help-toggle').on('click',function(){var section=$(this).closest('.accordion-section'),content=section.find('.customize-panel-description:first');if(section.hasClass('cannot-expand')){return}if(section.hasClass('open')){section.toggleClass('open');content.slideUp(api.Panel.prototype.defaultExpandedArguments.duration,function(){content.trigger('toggled')});$(this).attr('aria-expanded',false)}else{content.slideDown(api.Panel.prototype.defaultExpandedArguments.duration,function(){content.trigger('toggled')});section.toggleClass('open');$(this).attr('aria-expanded',true)}});api.previewer=new api.Previewer({container:'#customize-preview',form:'#customize-controls',previewUrl:api.settings.url.preview,allowedUrls:api.settings.url.allowed},{nonce:api.settings.nonce,query:function(options){var queryVars={wp_customize:'on',customize_theme:api.settings.theme.stylesheet,nonce:this.nonce.preview,customize_changeset_uuid:api.settings.changeset.uuid};if(api.settings.changeset.autosaved||!api.state('saved').get()){queryVars.customize_autosaved='on'}queryVars.customized=JSON.stringify(api.dirtyValues({unsaved:options&&options.excludeCustomizedSaved}));return queryVars},save:function(args){var previewer=this,deferred=$.Deferred(),changesetStatus=api.state('selectedChangesetStatus').get(),selectedChangesetDate=api.state('selectedChangesetDate').get(),processing=api.state('processing'),submitWhenDoneProcessing,submit,modifiedWhileSaving={},invalidSettings=[],invalidControls=[],invalidSettingLessControls=[];if(args&&args.status){changesetStatus=args.status}if(api.state('saving').get()){deferred.reject('already_saving');deferred.promise()}api.state('saving').set(true);function captureSettingModifiedDuringSave(setting){modifiedWhileSaving[setting.id]=true}submit=function(){var request,query,settingInvalidities={},latestRevision=api._latestRevision,errorCode='client_side_error';api.bind('change',captureSettingModifiedDuringSave);api.notifications.remove(errorCode);api.each(function(setting){setting.notifications.each(function(notification){if('error'===notification.type&&!notification.fromServer){invalidSettings.push(setting.id);if(!settingInvalidities[setting.id]){settingInvalidities[setting.id]={}}settingInvalidities[setting.id][notification.code]=notification}})});api.control.each(function(control){if(!control.setting||!control.setting.id&&control.active.get()){control.notifications.each(function(notification){if('error'===notification.type){invalidSettingLessControls.push([control])}})}});invalidControls=_.union(invalidSettingLessControls,_.values(api.findControlsForSettings(invalidSettings)));if(!_.isEmpty(invalidControls)){invalidControls[0][0].focus();api.unbind('change',captureSettingModifiedDuringSave);if(invalidSettings.length){api.notifications.add(new api.Notification(errorCode,{message:(1===invalidSettings.length?api.l10n.saveBlockedError.singular:api.l10n.saveBlockedError.plural).replace(/%s/g,String(invalidSettings.length)),type:'error',dismissible:true,saveFailure:true}))}deferred.rejectWith(previewer,[{setting_invalidities:settingInvalidities}]);api.state('saving').set(false);return deferred.promise()}query=$.extend(previewer.query({excludeCustomizedSaved:false}),{nonce:previewer.nonce.save,customize_changeset_status:changesetStatus});if(args&&args.date){query.customize_changeset_date=args.date}else if('future'===changesetStatus&&selectedChangesetDate){query.customize_changeset_date=selectedChangesetDate}if(args&&args.title){query.customize_changeset_title=args.title}api.trigger('save-request-params',query);request=wp.ajax.post('customize_save',query);api.state('processing').set(api.state('processing').get()+1);api.trigger('save',request);request.always(function(){api.state('processing').set(api.state('processing').get()-1);api.state('saving').set(false);api.unbind('change',captureSettingModifiedDuringSave)});api.notifications.each(function(notification){if(notification.saveFailure){api.notifications.remove(notification.code)}});request.fail(function(response){var notification,notificationArgs;notificationArgs={type:'error',dismissible:true,fromServer:true,saveFailure:true};if('0'===response){response='not_logged_in'}else if('-1'===response){response='invalid_nonce'}if('invalid_nonce'===response){previewer.cheatin()}else if('not_logged_in'===response){previewer.preview.iframe.hide();previewer.login().done(function(){previewer.save();previewer.preview.iframe.show()})}else if(response.code){if('not_future_date'===response.code&&api.section.has('publish_settings')&&api.section('publish_settings').active.get()&&api.control.has('changeset_scheduled_date')){api.control('changeset_scheduled_date').toggleFutureDateNotification(true).focus()}else if('changeset_locked'!==response.code){notification=new api.Notification(response.code,_.extend(notificationArgs,{message:response.message}))}}else{notification=new api.Notification('unknown_error',_.extend(notificationArgs,{message:api.l10n.unknownRequestFail}))}if(notification){api.notifications.add(notification)}if(response.setting_validities){api._handleSettingValidities({settingValidities:response.setting_validities,focusInvalidControl:true})}deferred.rejectWith(previewer,[response]);api.trigger('error',response);if('changeset_already_published'===response.code&&response.next_changeset_uuid){api.settings.changeset.uuid=response.next_changeset_uuid;api.state('changesetStatus').set('');if(api.settings.changeset.branching){parent.send('changeset-uuid',api.settings.changeset.uuid)}api.previewer.send('changeset-uuid',api.settings.changeset.uuid)}});request.done(function(response){previewer.send('saved',response);api.state('changesetStatus').set(response.changeset_status);if(response.changeset_date){api.state('changesetDate').set(response.changeset_date)}if('publish'===response.changeset_status){api.each(function(setting){if(setting._dirty&&(_.isUndefined(api._latestSettingRevisions[setting.id])||api._latestSettingRevisions[setting.id]<=latestRevision)){setting._dirty=false}});api.state('changesetStatus').set('');api.settings.changeset.uuid=response.next_changeset_uuid;if(api.settings.changeset.branching){parent.send('changeset-uuid',api.settings.changeset.uuid)}}api._lastSavedRevision=Math.max(latestRevision,api._lastSavedRevision);if(response.setting_validities){api._handleSettingValidities({settingValidities:response.setting_validities,focusInvalidControl:true})}deferred.resolveWith(previewer,[response]);api.trigger('saved',response);if(!_.isEmpty(modifiedWhileSaving)){api.state('saved').set(false)}})};if(0===processing()){submit()}else{submitWhenDoneProcessing=function(){if(0===processing()){api.state.unbind('change',submitWhenDoneProcessing);submit()}};api.state.bind('change',submitWhenDoneProcessing)}return deferred.promise()},trash:function trash(){var request,success,fail;api.state('trashing').set(true);api.state('processing').set(api.state('processing').get()+1);request=wp.ajax.post('customize_trash',{customize_changeset_uuid:api.settings.changeset.uuid,nonce:api.settings.nonce.trash});api.notifications.add(new api.OverlayNotification('changeset_trashing',{type:'info',message:api.l10n.revertingChanges,loading:true}));success=function(){var urlParser=document.createElement('a'),queryParams;api.state('changesetStatus').set('trash');api.each(function(setting){setting._dirty=false});api.state('saved').set(true);urlParser.href=location.href;queryParams=api.utils.parseQueryString(urlParser.search.substr(1));delete queryParams.changeset_uuid;queryParams['return']=api.settings.url['return'];urlParser.search=$.param(queryParams);location.replace(urlParser.href)};fail=function(code,message){var notificationCode=code||'unknown_error';api.state('processing').set(api.state('processing').get()-1);api.state('trashing').set(false);api.notifications.remove('changeset_trashing');api.notifications.add(new api.Notification(notificationCode,{message:message||api.l10n.unknownError,dismissible:true,type:'error'}))};request.done(function(response){success(response.message)});request.fail(function(response){var code=response.code||'trashing_failed';if(response.success||'non_existent_changeset'===code||'changeset_already_trashed'===code){success(response.message)}else{fail(code,response.message)}})},getFrontendPreviewUrl:function(){var previewer=this,params,urlParser;urlParser=document.createElement('a');urlParser.href=previewer.previewUrl.get();params=api.utils.parseQueryString(urlParser.search.substr(1));if(api.state('changesetStatus').get()&&'publish'!==api.state('changesetStatus').get()){params.customize_changeset_uuid=api.settings.changeset.uuid}if(!api.state('activated').get()){params.customize_theme=api.settings.theme.stylesheet}urlParser.search=$.param(params);return urlParser.href}});$.ajaxPrefilter(function injectPreviewNonce(options){if(!/wp_customize=on/.test(options.data)){return}options.data+='&'+$.param({customize_preview_nonce:api.settings.nonce.preview})});api.previewer.bind('nonce',function(nonce){$.extend(this.nonce,nonce)});api.bind('nonce-refresh',function(nonce){$.extend(api.settings.nonce,nonce);$.extend(api.previewer.nonce,nonce);api.previewer.send('nonce-refresh',nonce)});$.each(api.settings.settings,function(id,data){var Constructor=api.settingConstructor[data.type]||api.Setting;api.add(new Constructor(id,data.value,{transport:data.transport,previewer:api.previewer,dirty:!!data.dirty}))});$.each(api.settings.panels,function(id,data){var Constructor=api.panelConstructor[data.type]||api.Panel,options;options=_.extend({params:data},data);api.panel.add(new Constructor(id,options))});$.each(api.settings.sections,function(id,data){var Constructor=api.sectionConstructor[data.type]||api.Section,options;options=_.extend({params:data},data);api.section.add(new Constructor(id,options))});$.each(api.settings.controls,function(id,data){var Constructor=api.controlConstructor[data.type]||api.Control,options;options=_.extend({params:data},data);api.control.add(new Constructor(id,options))});_.each(['panel','section','control'],function(type){var id=api.settings.autofocus[type];if(!id){return}api[type](id,function(instance){instance.deferred.embedded.done(function(){api.previewer.deferred.active.done(function(){instance.focus()})})})});api.bind('ready',api.reflowPaneContents);$([api.panel,api.section,api.control]).each(function(i,values){var debouncedReflowPaneContents=_.debounce(api.reflowPaneContents,api.settings.timeouts.reflowPaneContents);values.bind('add',debouncedReflowPaneContents);values.bind('change',debouncedReflowPaneContents);values.bind('remove',debouncedReflowPaneContents)});api.bind('ready',function setUpGlobalNotificationsArea(){var sidebar,containerHeight,containerInitialTop;api.notifications.container=$('#customize-notifications-area');api.notifications.bind('change',_.debounce(function(){api.notifications.render()}));sidebar=$('.wp-full-overlay-sidebar-content');api.notifications.bind('rendered',function updateSidebarTop(){sidebar.css('top','');if(0!==api.notifications.count()){containerHeight=api.notifications.container.outerHeight()+1;containerInitialTop=parseInt(sidebar.css('top'),10);sidebar.css('top',containerInitialTop+containerHeight+'px')}api.notifications.trigger('sidebarTopUpdated')});api.notifications.render()});(function(state){var saved=state.instance('saved'),saving=state.instance('saving'),trashing=state.instance('trashing'),activated=state.instance('activated'),processing=state.instance('processing'),paneVisible=state.instance('paneVisible'),expandedPanel=state.instance('expandedPanel'),expandedSection=state.instance('expandedSection'),changesetStatus=state.instance('changesetStatus'),selectedChangesetStatus=state.instance('selectedChangesetStatus'),changesetDate=state.instance('changesetDate'),selectedChangesetDate=state.instance('selectedChangesetDate'),previewerAlive=state.instance('previewerAlive'),editShortcutVisibility=state.instance('editShortcutVisibility'),changesetLocked=state.instance('changesetLocked'),populateChangesetUuidParam,defaultSelectedChangesetStatus;state.bind('change',function(){var canSave;if(!activated()){saveBtn.val(api.l10n.activate);closeBtn.find('.screen-reader-text').text(api.l10n.cancel)}else if(''===changesetStatus.get()&&saved()){if(api.settings.changeset.currentUserCanPublish){saveBtn.val(api.l10n.published)}else{saveBtn.val(api.l10n.saved)}closeBtn.find('.screen-reader-text').text(api.l10n.close)}else{if('draft'===selectedChangesetStatus()){if(saved()&&selectedChangesetStatus()===changesetStatus()){saveBtn.val(api.l10n.draftSaved)}else{saveBtn.val(api.l10n.saveDraft)}}else if('future'===selectedChangesetStatus()){if(saved()&&selectedChangesetStatus()===changesetStatus()){if(changesetDate.get()!==selectedChangesetDate.get()){saveBtn.val(api.l10n.schedule)}else{saveBtn.val(api.l10n.scheduled)}}else{saveBtn.val(api.l10n.schedule)}}else if(api.settings.changeset.currentUserCanPublish){saveBtn.val(api.l10n.publish)}closeBtn.find('.screen-reader-text').text(api.l10n.cancel)}canSave=!saving()&&!trashing()&&!changesetLocked()&&(!activated()||!saved()||(changesetStatus()!==selectedChangesetStatus()&&''!==changesetStatus())||('future'===selectedChangesetStatus()&&changesetDate.get()!==selectedChangesetDate.get()));saveBtn.prop('disabled',!canSave)});selectedChangesetStatus.validate=function(status){if(''===status||'auto-draft'===status){return null}return status};defaultSelectedChangesetStatus=api.settings.changeset.currentUserCanPublish?'publish':'draft';changesetStatus(api.settings.changeset.status);changesetLocked(Boolean(api.settings.changeset.lockUser));changesetDate(api.settings.changeset.publishDate);selectedChangesetDate(api.settings.changeset.publishDate);selectedChangesetStatus(''===api.settings.changeset.status||'auto-draft'===api.settings.changeset.status?defaultSelectedChangesetStatus:api.settings.changeset.status);selectedChangesetStatus.link(changesetStatus);saved(true);if(''===changesetStatus()){api.each(function(setting){if(setting._dirty){saved(false)}})}saving(false);activated(api.settings.theme.active);processing(0);paneVisible(true);expandedPanel(false);expandedSection(false);previewerAlive(true);editShortcutVisibility('visible');api.bind('change',function(){if(state('saved').get()){state('saved').set(false)}});if(api.settings.changeset.branching){saved.bind(function(isSaved){if(!isSaved){populateChangesetUuidParam(true)}})}saving.bind(function(isSaving){body.toggleClass('saving',isSaving)});trashing.bind(function(isTrashing){body.toggleClass('trashing',isTrashing)});api.bind('saved',function(response){state('saved').set(true);if('publish'===response.changeset_status){state('activated').set(true)}});activated.bind(function(to){if(to){api.trigger('activated')}});populateChangesetUuidParam=function(isIncluded){var urlParser,queryParams;if(!history.replaceState){return}urlParser=document.createElement('a');urlParser.href=location.href;queryParams=api.utils.parseQueryString(urlParser.search.substr(1));if(isIncluded){if(queryParams.changeset_uuid===api.settings.changeset.uuid){return}queryParams.changeset_uuid=api.settings.changeset.uuid}else{if(!queryParams.changeset_uuid){return}delete queryParams.changeset_uuid}urlParser.search=$.param(queryParams);history.replaceState({},document.title,urlParser.href)};if(api.settings.changeset.branching){changesetStatus.bind(function(newStatus){populateChangesetUuidParam(''!==newStatus&&'publish'!==newStatus&&'trash'!==newStatus)})}}(api.state));(function checkAndDisplayLockNotice(){var LockedNotification=api.OverlayNotification.extend({templateId:'customize-changeset-locked-notification',lockUser:null,initialize:function(code,params){var notification=this,_code,_params;_code=code||'changeset_locked';_params=_.extend({type:'warning',containerClasses:'',lockUser:{}},params);_params.containerClasses+=' notification-changeset-locked';api.OverlayNotification.prototype.initialize.call(notification,_code,_params)},render:function(){var notification=this,li,data,takeOverButton,request;data=_.extend({allowOverride:false,returnUrl:api.settings.url['return'],previewUrl:api.previewer.previewUrl.get(),frontendPreviewUrl:api.previewer.getFrontendPreviewUrl()},this);li=api.OverlayNotification.prototype.render.call(data);api.requestChangesetUpdate({},{autosave:true}).fail(function(response){if(!response.autosaved){li.find('.notice-error').prop('hidden',false).text(response.message||api.l10n.unknownRequestFail)}});takeOverButton=li.find('.customize-notice-take-over-button');takeOverButton.on('click',function(event){event.preventDefault();if(request){return}takeOverButton.addClass('disabled');request=wp.ajax.post('customize_override_changeset_lock',{wp_customize:'on',customize_theme:api.settings.theme.stylesheet,customize_changeset_uuid:api.settings.changeset.uuid,nonce:api.settings.nonce.override_lock});request.done(function(){api.notifications.remove(notification.code);api.state('changesetLocked').set(false)});request.fail(function(response){var message=response.message||api.l10n.unknownRequestFail;li.find('.notice-error').prop('hidden',false).text(message);request.always(function(){takeOverButton.removeClass('disabled')})});request.always(function(){request=null})});return li}});function startLock(args){if(args&&args.lockUser){api.settings.changeset.lockUser=args.lockUser}api.state('changesetLocked').set(true);api.notifications.add(new LockedNotification('changeset_locked',{lockUser:api.settings.changeset.lockUser,allowOverride:Boolean(args&&args.allowOverride)}))}if(api.settings.changeset.lockUser){startLock({allowOverride:true})}$(document).on('heartbeat-send.update_lock_notice',function(event,data){data.check_changeset_lock=true;data.changeset_uuid=api.settings.changeset.uuid});$(document).on('heartbeat-tick.update_lock_notice',function(event,data){var notification,code='changeset_locked';if(!data.customize_changeset_lock_user){return}notification=api.notifications(code);if(notification&&notification.lockUser.id!==api.settings.changeset.lockUser.id){api.notifications.remove(code)}startLock({lockUser:data.customize_changeset_lock_user})});api.bind('error',function(response){if('changeset_locked'===response.code&&response.lock_user){startLock({lockUser:response.lock_user})}})})();(function(){var removedQueryParams=[],autosaveDismissed=false;function getAutosaveRestorationUrl(){var urlParser,queryParams;urlParser=document.createElement('a');urlParser.href=location.href;queryParams=api.utils.parseQueryString(urlParser.search.substr(1));if(api.settings.changeset.latestAutoDraftUuid){queryParams.changeset_uuid=api.settings.changeset.latestAutoDraftUuid}else{queryParams.customize_autosaved='on'}queryParams['return']=api.settings.url['return'];urlParser.search=$.param(queryParams);return urlParser.href}function stripParamsFromLocation(params){var urlParser=document.createElement('a'),queryParams,strippedParams=0;urlParser.href=location.href;queryParams=api.utils.parseQueryString(urlParser.search.substr(1));_.each(params,function(param){if('undefined'!==typeof queryParams[param]){strippedParams+=1;delete queryParams[param]}});if(0===strippedParams){return}urlParser.search=$.param(queryParams);history.replaceState({},document.title,urlParser.href)}function dismissAutosave(){if(autosaveDismissed){return}wp.ajax.post('customize_dismiss_autosave_or_lock',{wp_customize:'on',customize_theme:api.settings.theme.stylesheet,customize_changeset_uuid:api.settings.changeset.uuid,nonce:api.settings.nonce.dismiss_autosave_or_lock,dismiss_autosave:true});autosaveDismissed=true}function addAutosaveRestoreNotification(){var code='autosave_available',onStateChange;api.notifications.add(new api.Notification(code,{message:api.l10n.autosaveNotice,type:'warning',dismissible:true,render:function(){var li=api.Notification.prototype.render.call(this),link;link=li.find('a');link.prop('href',getAutosaveRestorationUrl());link.on('click',function(event){event.preventDefault();location.replace(getAutosaveRestorationUrl())});li.find('.notice-dismiss').on('click',dismissAutosave);return li}}));onStateChange=function(){dismissAutosave();api.notifications.remove(code);api.unbind('change',onStateChange);api.state('changesetStatus').unbind(onStateChange)};api.bind('change',onStateChange);api.state('changesetStatus').bind(onStateChange)}if(api.settings.changeset.autosaved){api.state('saved').set(false);removedQueryParams.push('customize_autosaved')}if(!api.settings.changeset.branching&&(!api.settings.changeset.status||'auto-draft'===api.settings.changeset.status)){removedQueryParams.push('changeset_uuid')}if(removedQueryParams.length>0){stripParamsFromLocation(removedQueryParams)}if(api.settings.changeset.latestAutoDraftUuid||api.settings.changeset.hasAutosaveRevision){addAutosaveRestoreNotification()}})();if(api.previewer.previewUrl()){api.previewer.refresh()}else{api.previewer.previewUrl(api.settings.url.home)}saveBtn.click(function(event){api.previewer.save();event.preventDefault()}).keydown(function(event){if(9===event.which){return}if(13===event.which){api.previewer.save()}event.preventDefault()});closeBtn.keydown(function(event){if(9===event.which){return}if(13===event.which){this.click()}event.preventDefault()});$('.collapse-sidebar').on('click',function(){api.state('paneVisible').set(!api.state('paneVisible').get())});api.state('paneVisible').bind(function(paneVisible){overlay.toggleClass('preview-only',!paneVisible);overlay.toggleClass('expanded',paneVisible);overlay.toggleClass('collapsed',!paneVisible);if(!paneVisible){$('.collapse-sidebar').attr({'aria-expanded':'false','aria-label':api.l10n.expandSidebar})}else{$('.collapse-sidebar').attr({'aria-expanded':'true','aria-label':api.l10n.collapseSidebar})}});body.on('keydown',function(event){var collapsedObject,expandedControls=[],expandedSections=[],expandedPanels=[];if(27!==event.which){return}if(!$(event.target).is('body')&&!$.contains($('#customize-controls')[0],event.target)){return}api.control.each(function(control){if(control.expanded&&control.expanded()&&_.isFunction(control.collapse)){expandedControls.push(control)}});api.section.each(function(section){if(section.expanded()){expandedSections.push(section)}});api.panel.each(function(panel){if(panel.expanded()){expandedPanels.push(panel)}});if(expandedControls.length>0&&0===expandedSections.length){expandedControls.length=0}collapsedObject=expandedControls[0]||expandedSections[0]||expandedPanels[0];if(collapsedObject){if('themes'===collapsedObject.params.type){if(body.hasClass('modal-open')){collapsedObject.closeDetails()}else if(api.panel.has('themes')){api.panel('themes').collapse()}return}collapsedObject.collapse();event.preventDefault()}});$('.customize-controls-preview-toggle').on('click',function(){api.state('paneVisible').set(!api.state('paneVisible').get())});(function initStickyHeaders(){var parentContainer=$('.wp-full-overlay-sidebar-content'),changeContainer,updateHeaderHeight,releaseStickyHeader,resetStickyHeader,positionStickyHeader,activeHeader,lastScrollTop;changeContainer=function(container){var newInstance=container,expandedSection=api.state('expandedSection').get(),expandedPanel=api.state('expandedPanel').get(),headerElement;if(activeHeader&&activeHeader.element){releaseStickyHeader(activeHeader.element);activeHeader.element.find('.description').off('toggled',updateHeaderHeight)}if(!newInstance){if(!expandedSection&&expandedPanel&&expandedPanel.contentContainer){newInstance=expandedPanel}else if(!expandedPanel&&expandedSection&&expandedSection.contentContainer){newInstance=expandedSection}else{activeHeader=false;return}}headerElement=newInstance.contentContainer.find('.customize-section-title, .panel-meta').first();if(headerElement.length){activeHeader={instance:newInstance,element:headerElement,parent:headerElement.closest('.customize-pane-child'),height:headerElement.outerHeight()};activeHeader.element.find('.description').on('toggled',updateHeaderHeight);if(expandedSection){resetStickyHeader(activeHeader.element,activeHeader.parent)}}else{activeHeader=false}};api.state('expandedSection').bind(changeContainer);api.state('expandedPanel').bind(changeContainer);parentContainer.on('scroll',_.throttle(function(){if(!activeHeader){return}var scrollTop=parentContainer.scrollTop(),scrollDirection;if(!lastScrollTop){scrollDirection=1}else{if(scrollTop===lastScrollTop){scrollDirection=0}else if(scrollTop>lastScrollTop){scrollDirection=1}else{scrollDirection=-1}}lastScrollTop=scrollTop;if(0!==scrollDirection){positionStickyHeader(activeHeader,scrollTop,scrollDirection)}},8));api.notifications.bind('sidebarTopUpdated',function(){if(activeHeader&&activeHeader.element.hasClass('is-sticky')){activeHeader.element.css('top',parentContainer.css('top'))}});releaseStickyHeader=function(headerElement){if(!headerElement.hasClass('is-sticky')){return}headerElement.removeClass('is-sticky').addClass('maybe-sticky is-in-view').css('top',parentContainer.scrollTop()+'px')};resetStickyHeader=function(headerElement,headerParent){if(headerElement.hasClass('is-in-view')){headerElement.removeClass('maybe-sticky is-in-view').css({width:'',top:''});headerParent.css('padding-top','')}};updateHeaderHeight=function(){activeHeader.height=activeHeader.element.outerHeight()};positionStickyHeader=function(header,scrollTop,scrollDirection){var headerElement=header.element,headerParent=header.parent,headerHeight=header.height,headerTop=parseInt(headerElement.css('top'),10),maybeSticky=headerElement.hasClass('maybe-sticky'),isSticky=headerElement.hasClass('is-sticky'),isInView=headerElement.hasClass('is-in-view'),isScrollingUp=(-1===scrollDirection);if(!isScrollingUp){if(isSticky){headerTop=scrollTop;headerElement.removeClass('is-sticky').css({top:headerTop+'px',width:''})}if(isInView&&scrollTop>headerTop+headerHeight){headerElement.removeClass('is-in-view');headerParent.css('padding-top','')}return}if(!maybeSticky&&scrollTop>=headerHeight){maybeSticky=true;headerElement.addClass('maybe-sticky')}else if(0===scrollTop){headerElement.removeClass('maybe-sticky is-in-view is-sticky').css({top:'',width:''});headerParent.css('padding-top','');return}if(isInView&&!isSticky){if(headerTop>=scrollTop){headerElement.addClass('is-sticky').css({top:parentContainer.css('top'),width:headerParent.outerWidth()+'px'})}}else if(maybeSticky&&!isInView){headerElement.addClass('is-in-view').css('top',(scrollTop-headerHeight)+'px');headerParent.css('padding-top',headerHeight+'px')}}}());api.previewedDevice=api.state('previewedDevice');api.bind('ready',function(){_.find(api.settings.previewableDevices,function(value,key){if(true===value['default']){api.previewedDevice.set(key);return true}})});footerActions.find('.devices button').on('click',function(event){api.previewedDevice.set($(event.currentTarget).data('device'))});api.previewedDevice.bind(function(newDevice){var overlay=$('.wp-full-overlay'),devices='';footerActions.find('.devices button').removeClass('active').attr('aria-pressed',false);footerActions.find('.devices .preview-'+newDevice).addClass('active').attr('aria-pressed',true);$.each(api.settings.previewableDevices,function(device){devices+=' preview-'+device});overlay.removeClass(devices).addClass('preview-'+newDevice)});if(title.length){api('blogname',function(setting){var updateTitle=function(){title.text($.trim(setting())||api.l10n.untitledBlogName)};setting.bind(updateTitle);updateTitle()})}parent=new api.Messenger({url:api.settings.url.parent,channel:'loader'});(function(){var isInsideIframe=false;function isCleanState(){var defaultChangesetStatus;if(!api.state('activated').get()){return 0===api._latestRevision}defaultChangesetStatus=api.state('changesetStatus').get();if(''===defaultChangesetStatus||'auto-draft'===defaultChangesetStatus){defaultChangesetStatus='publish'}if(api.state('selectedChangesetStatus').get()!==defaultChangesetStatus){return false}if('future'===api.state('selectedChangesetStatus').get()&&api.state('selectedChangesetDate').get()!==api.state('changesetDate').get()){return false}return api.state('saved').get()&&'auto-draft'!==api.state('changesetStatus').get()}parent.bind('back',function(){isInsideIframe=true});function startPromptingBeforeUnload(){api.unbind('change',startPromptingBeforeUnload);api.state('selectedChangesetStatus').unbind(startPromptingBeforeUnload);api.state('selectedChangesetDate').unbind(startPromptingBeforeUnload);$(window).on('beforeunload.customize-confirm',function(){if(!isCleanState()&&!api.state('changesetLocked').get()){setTimeout(function(){overlay.removeClass('customize-loading')},1);return api.l10n.saveAlert}})}api.bind('change',startPromptingBeforeUnload);api.state('selectedChangesetStatus').bind(startPromptingBeforeUnload);api.state('selectedChangesetDate').bind(startPromptingBeforeUnload);function requestClose(){var clearedToClose=$.Deferred(),dismissAutoSave=false,dismissLock=false;if(isCleanState()){dismissLock=true}else if(confirm(api.l10n.saveAlert)){dismissLock=true;api.each(function(setting){setting._dirty=false});$(document).off('visibilitychange.wp-customize-changeset-update');$(window).off('beforeunload.wp-customize-changeset-update');closeBtn.css('cursor','progress');if(''!==api.state('changesetStatus').get()){dismissAutoSave=true}}else{clearedToClose.reject()}if(dismissLock||dismissAutoSave){wp.ajax.send('customize_dismiss_autosave_or_lock',{timeout:500,data:{wp_customize:'on',customize_theme:api.settings.theme.stylesheet,customize_changeset_uuid:api.settings.changeset.uuid,nonce:api.settings.nonce.dismiss_autosave_or_lock,dismiss_autosave:dismissAutoSave,dismiss_lock:dismissLock}}).always(function(){clearedToClose.resolve()})}return clearedToClose.promise()}parent.bind('confirm-close',function(){requestClose().done(function(){parent.send('confirmed-close',true)}).fail(function(){parent.send('confirmed-close',false)})});closeBtn.on('click.customize-controls-close',function(event){event.preventDefault();if(isInsideIframe){parent.send('close')}else{requestClose().done(function(){$(window).off('beforeunload.customize-confirm');window.location.href=closeBtn.prop('href')})}})})();$.each(['saved','change'],function(i,event){api.bind(event,function(){parent.send(event)})});api.bind('title',function(newTitle){parent.send('title',newTitle)});if(api.settings.changeset.branching){parent.send('changeset-uuid',api.settings.changeset.uuid)}parent.send('ready');$.each({'background_image':{controls:['background_preset','background_position','background_size','background_repeat','background_attachment'],callback:function(to){return!!to}},'show_on_front':{controls:['page_on_front','page_for_posts'],callback:function(to){return'page'===to}},'header_textcolor':{controls:['header_textcolor'],callback:function(to){return'blank'!==to}}},function(settingId,o){api(settingId,function(setting){$.each(o.controls,function(i,controlId){api.control(controlId,function(control){var visibility=function(to){control.container.toggle(o.callback(to))};visibility(setting.get());setting.bind(visibility)})})})});api.control('background_preset',function(control){var visibility,defaultValues,values,toggleVisibility,updateSettings,preset;visibility={'default':[false,false,false,false],'fill':[true,false,false,false],'fit':[true,false,true,false],'repeat':[true,false,false,true],'custom':[true,true,true,true]};defaultValues=[_wpCustomizeBackground.defaults['default-position-x'],_wpCustomizeBackground.defaults['default-position-y'],_wpCustomizeBackground.defaults['default-size'],_wpCustomizeBackground.defaults['default-repeat'],_wpCustomizeBackground.defaults['default-attachment']];values={'default':defaultValues,'fill':['left','top','cover','no-repeat','fixed'],'fit':['left','top','contain','no-repeat','fixed'],'repeat':['left','top','auto','repeat','scroll']};toggleVisibility=function(preset){_.each(['background_position','background_size','background_repeat','background_attachment'],function(controlId,i){var control=api.control(controlId);if(control){control.container.toggle(visibility[preset][i])}})};updateSettings=function(preset){_.each(['background_position_x','background_position_y','background_size','background_repeat','background_attachment'],function(settingId,i){var setting=api(settingId);if(setting){setting.set(values[preset][i])}})};preset=control.setting.get();toggleVisibility(preset);control.setting.bind('change',function(preset){toggleVisibility(preset);if('custom'!==preset){updateSettings(preset)}})});api.control('background_repeat',function(control){control.elements[0].unsync(api('background_repeat'));control.element=new api.Element(control.container.find('input'));control.element.set('no-repeat'!==control.setting());control.element.bind(function(to){control.setting.set(to?'repeat':'no-repeat')});control.setting.bind(function(to){control.element.set('no-repeat'!==to)})});api.control('background_attachment',function(control){control.elements[0].unsync(api('background_attachment'));control.element=new api.Element(control.container.find('input'));control.element.set('fixed'!==control.setting());control.element.bind(function(to){control.setting.set(to?'scroll':'fixed')});control.setting.bind(function(to){control.element.set('fixed'!==to)})});api.control('display_header_text',function(control){var last='';control.elements[0].unsync(api('header_textcolor'));control.element=new api.Element(control.container.find('input'));control.element.set('blank'!==control.setting());control.element.bind(function(to){if(!to){last=api('header_textcolor').get()}control.setting.set(to?last:'blank')});control.setting.bind(function(to){control.element.set('blank'!==to)})});api('show_on_front','page_on_front','page_for_posts',function(showOnFront,pageOnFront,pageForPosts){var handleChange=function(){var setting=this,pageOnFrontId,pageForPostsId,errorCode='show_on_front_page_collision';pageOnFrontId=parseInt(pageOnFront(),10);pageForPostsId=parseInt(pageForPosts(),10);if('page'===showOnFront()){if(setting===pageOnFront&&pageOnFrontId>0){api.previewer.previewUrl.set(api.settings.url.home)}if(setting===pageForPosts&&pageForPostsId>0){api.previewer.previewUrl.set(api.settings.url.home+'?page_id='+pageForPostsId)}}if('page'===showOnFront()&&pageOnFrontId&&pageForPostsId&&pageOnFrontId===pageForPostsId){showOnFront.notifications.add(new api.Notification(errorCode,{type:'error',message:api.l10n.pageOnFrontError}))}else{showOnFront.notifications.remove(errorCode)}};showOnFront.bind(handleChange);pageOnFront.bind(handleChange);pageForPosts.bind(handleChange);handleChange.call(showOnFront,showOnFront());api.control('show_on_front',function(showOnFrontControl){showOnFrontControl.deferred.embedded.done(function(){showOnFrontControl.container.append(showOnFrontControl.getNotificationsContainerElement())})})});(function(){var sectionReady=$.Deferred();api.section('custom_css',function(section){section.deferred.embedded.done(function(){if(section.expanded()){sectionReady.resolve(section)}else{section.expanded.bind(function(isExpanded){if(isExpanded){sectionReady.resolve(section)}})}})});sectionReady.done(function setupSectionDescription(section){var control=api.control('custom_css');control.container.find('.customize-control-title:first').addClass('screen-reader-text');section.container.find('.section-description-buttons .section-description-close').on('click',function(){section.container.find('.section-meta .customize-section-description:first').removeClass('open').slideUp();section.container.find('.customize-help-toggle').attr('aria-expanded','false').focus()});if(control&&!control.setting.get()){section.container.find('.section-meta .customize-section-description:first').addClass('open').show().trigger('toggled');section.container.find('.customize-help-toggle').attr('aria-expanded','true')}})})();api.control('header_video',function(headerVideoControl){headerVideoControl.deferred.embedded.done(function(){var toggleNotice=function(){var section=api.section(headerVideoControl.section()),noticeCode='video_header_not_available';if(!section){return}if(headerVideoControl.active.get()){section.notifications.remove(noticeCode)}else{section.notifications.add(new api.Notification(noticeCode,{type:'info',message:api.l10n.videoHeaderNotice}))}};toggleNotice();headerVideoControl.active.bind(toggleNotice)})});api.previewer.bind('selective-refresh-setting-validities',function handleSelectiveRefreshedSettingValidities(settingValidities){api._handleSettingValidities({settingValidities:settingValidities,focusInvalidControl:false})});api.previewer.bind('focus-control-for-setting',function(settingId){var matchedControls=[];api.control.each(function(control){var settingIds=_.pluck(control.settings,'id');if(-1!==_.indexOf(settingIds,settingId)){matchedControls.push(control)}});if(matchedControls.length){matchedControls.sort(function(a,b){return a.priority()-b.priority()});matchedControls[0].focus()}});api.previewer.bind('refresh',function(){api.previewer.refresh()});api.state('paneVisible').bind(function(isPaneVisible){var isMobileScreen;if(window.matchMedia){isMobileScreen=window.matchMedia('screen and ( max-width: 640px )').matches}else{isMobileScreen=$(window).width()<=640}api.state('editShortcutVisibility').set(isPaneVisible||isMobileScreen?'visible':'hidden')});if(window.matchMedia){window.matchMedia('screen and ( max-width: 640px )').addListener(function(){var state=api.state('paneVisible');state.callbacks.fireWith(state,[state.get(),state.get()])})}api.previewer.bind('edit-shortcut-visibility',function(visibility){api.state('editShortcutVisibility').set(visibility)});api.state('editShortcutVisibility').bind(function(visibility){api.previewer.send('edit-shortcut-visibility',visibility)});function startAutosaving(){var timeoutId,updateChangesetWithReschedule,scheduleChangesetUpdate,updatePending=false;api.unbind('change',startAutosaving);function onChangeSaved(isSaved){if(!isSaved&&!api.settings.changeset.autosaved){api.settings.changeset.autosaved=true;api.previewer.send('autosaving')}}api.state('saved').bind(onChangeSaved);onChangeSaved(api.state('saved').get());updateChangesetWithReschedule=function(){if(!updatePending){updatePending=true;api.requestChangesetUpdate({},{autosave:true}).always(function(){updatePending=false})}scheduleChangesetUpdate()};scheduleChangesetUpdate=function(){clearTimeout(timeoutId);timeoutId=setTimeout(function(){updateChangesetWithReschedule()},api.settings.timeouts.changesetAutoSave)};scheduleChangesetUpdate();$(document).on('visibilitychange.wp-customize-changeset-update',function(){if(document.hidden){updateChangesetWithReschedule()}});$(window).on('beforeunload.wp-customize-changeset-update',function(){updateChangesetWithReschedule()})}api.bind('change',startAutosaving);$(document).one('tinymce-editor-setup',function(){if(window.tinymce.ui.FloatPanel&&(!window.tinymce.ui.FloatPanel.zIndex||window.tinymce.ui.FloatPanel.zIndex<500001)){window.tinymce.ui.FloatPanel.zIndex=500001}});body.addClass('ready');api.trigger('ready')})})(wp,jQuery);